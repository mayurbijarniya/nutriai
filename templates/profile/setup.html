{% extends "base.html" %}

{% block title %}Profile Setup - NutriAI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="text-center mb-10">
        <div
            class="inline-flex items-center space-x-2 bg-green-500/10 text-green-600 dark:text-green-400 px-4 py-1.5 rounded-full text-sm font-medium mb-6 border border-green-500/20 backdrop-blur-sm shadow-sm">
            <i class="ph ph-sparkle text-lg"></i>
            <span>Personalized Nutrition</span>
        </div>

        <h1
            class="text-4xl md:text-5xl font-bold tracking-tight mb-4 text-gray-900 dark:text-gray-100 font-serif-accent">
            Complete Your Profile</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto leading-relaxed">
            Help us tailor your nutrition plan by sharing a few details about your lifestyle and goals.
        </p>
    </div>

    <!-- Progress Bar -->
    <div class="mb-8 max-w-2xl mx-auto">
        <div class="flex items-center justify-between text-sm text-gray-600 dark:text-gray-400 mb-2 font-medium">
            <span class="uppercase tracking-wider text-xs font-bold text-gray-500">Progress</span>
            <span id="progressText" class="font-serif-accent text-green-600 dark:text-green-400">Step 1 of 5</span>
        </div>
        <div
            class="w-full bg-gray-200/50 dark:bg-gray-700/50 rounded-full h-2.5 overflow-hidden backdrop-blur-sm shadow-inner">
            <div id="progressBar"
                class="bg-gradient-to-r from-green-500 to-emerald-500 h-full rounded-full transition-all duration-500 shadow-glow relative"
                style="width: 20%">
                <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="glass-panel rounded-3xl overflow-hidden shadow-xl">
        <form id="profileForm" class="relative">
            <!-- Section 1: Basic Information -->
            <div id="section1" class="form-section p-8 lg:p-10 animate-fade-in">
                <div class="flex items-center space-x-4 mb-8">
                    <div
                        class="w-12 h-12 bg-green-100/50 dark:bg-green-900/30 rounded-2xl flex items-center justify-center border border-green-200/50 dark:border-green-800/30">
                        <i class="ph ph-user text-2xl text-green-600 dark:text-green-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 font-serif-accent">Basic
                            Information</h2>
                        <p class="text-gray-500 dark:text-gray-400">Tell us about yourself to get started</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Age -->
                    <div>
                        <label for="age" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Age <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="age" name="age" min="13" max="120" required
                            class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 focus:border-green-500 transition-all text-gray-900 dark:text-gray-100 placeholder-gray-400"
                            placeholder="Years">
                    </div>

                    <!-- Biological Sex -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Biological Sex <span class="text-red-500">*</span>
                        </label>
                        <div class="flex flex-wrap gap-3">
                            {% for sex in constants.biological_sex_options %}
                            <label class="cursor-pointer">
                                <input type="radio" name="biological_sex" value="{{ sex }}" required
                                    class="peer sr-only">
                                <div
                                    class="px-5 py-2.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-white/40 dark:bg-black/20 text-gray-600 dark:text-gray-300 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500 transition-all hover:bg-gray-50 dark:hover:bg-white/5 shadow-sm text-sm font-medium capitalize">
                                    {{ sex.replace('_', ' ') }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Height -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Height <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-3">
                            <div class="relative flex-1">
                                <select id="heightFeet" name="height_feet" required
                                    class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                    <option value="">Of</option>
                                    {% for i in range(3, 9) %}
                                    <option value="{{ i }}">{{ i }} ft</option>
                                    {% endfor %}
                                </select>
                                <i
                                    class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                            <div class="relative flex-1">
                                <input type="number" id="heightInches" name="height_inches" min="0" max="11.9"
                                    step="0.1" required
                                    class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 text-gray-900 dark:text-gray-100 placeholder-gray-400"
                                    placeholder="Inches">
                            </div>
                        </div>
                        <p class="text-xs font-mono text-gray-400 mt-2 ml-1">
                            Metric: <span id="heightCm" class="font-bold text-green-600 dark:text-green-400">-</span>
                        </p>
                    </div>

                    <!-- Weight -->
                    <div>
                        <label for="weight" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Weight <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-3">
                            <input type="number" id="weight" name="weight" min="50" max="1000" step="0.1" required
                                class="input-glass flex-1 px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 text-gray-900 dark:text-gray-100"
                                placeholder="Weight in lbs">
                            <div
                                class="px-4 py-3 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-xl text-gray-600 dark:text-gray-300 font-medium flex items-center justify-center min-w-[3.5rem]">
                                lbs
                            </div>
                        </div>
                        <p class="text-xs font-mono text-gray-400 mt-2 ml-1">
                            Metric: <span id="weightKg" class="font-bold text-green-600 dark:text-green-400">-</span>
                        </p>
                    </div>

                    <!-- Activity Level -->
                    <div class="md:col-span-2">
                        <label for="activity_level"
                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Activity Level <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select id="activity_level" name="activity_level" required
                                class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                <option value="">Select your activity level</option>
                                <option value="sedentary">Sedentary (little or no exercise, desk job)</option>
                                <option value="lightly_active">Lightly Active (light exercise 1-3 days/week)</option>
                                <option value="moderately_active">Moderately Active (moderate exercise 3-5 days/week)
                                </option>
                                <option value="very_active">Very Active (hard exercise 6-7 days/week)</option>
                                <option value="extremely_active">Extremely Active (very hard exercise, physical job)
                                </option>
                            </select>
                            <i
                                class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-lg"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Health Information -->
            <div id="section2" class="form-section p-8 lg:p-10 hidden animate-fade-in">
                <div class="flex items-center space-x-4 mb-8">
                    <div
                        class="w-12 h-12 bg-red-100/50 dark:bg-red-900/30 rounded-2xl flex items-center justify-center border border-red-200/50 dark:border-red-800/30">
                        <i class="ph ph-heart text-2xl text-red-600 dark:text-red-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 font-serif-accent">Health
                            Information</h2>
                        <p class="text-gray-500 dark:text-gray-400">Help us provide safe recommendations</p>
                    </div>
                </div>

                <!-- Health Conditions -->
                <div class="mb-8">
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                        Health Conditions
                        <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Select all that
                            apply)</span>
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        {% for condition in constants.health_conditions %}
                        <label
                            class="relative flex items-start p-4 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-all group">
                            <div class="flex items-center h-5">
                                <input type="checkbox" name="health_conditions" value="{{ condition }}"
                                    class="peer sr-only">
                                <div
                                    class="w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded flex items-center justify-center peer-checked:bg-green-500 peer-checked:border-green-500 transition-colors">
                                    <i class="ph ph-check text-white text-xs opacity-0 peer-checked:opacity-100"></i>
                                </div>
                            </div>
                            <span
                                class="ml-3 text-sm text-gray-700 dark:text-gray-200 group-hover:text-gray-900 dark:group-hover:text-white transition-colors">
                                {% if condition == 'diabetes_type1' %}Type 1 Diabetes
                                {% elif condition == 'diabetes_type2' %}Type 2 Diabetes
                                {% elif condition == 'hypertension' %}High Blood Pressure
                                {% elif condition == 'heart_disease' %}Heart Disease
                                {% elif condition == 'kidney_disease' %}Kidney Disease
                                {% elif condition == 'celiac' %}Celiac Disease
                                {% elif condition == 'ibs' %}Irritable Bowel Syndrome
                                {% elif condition == 'food_allergies' %}Food Allergies
                                {% elif condition == 'thyroid_issues' %}Thyroid Issues
                                {% elif condition == 'none' %}None of the above
                                {% else %}{{ condition.replace('_', ' ').title() }}
                                {% endif %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <!-- Medications -->
                <div class="mb-8">
                    <label for="medications" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                        Current Medications
                        <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Optional)</span>
                    </label>
                    <textarea id="medications" name="medications" rows="3"
                        class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 resize-none text-gray-900 dark:text-gray-100 placeholder-gray-400"
                        placeholder="List any medications that might affect nutrition..."></textarea>
                </div>

                <!-- Supplements -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                        Current Supplements
                        <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Select all that
                            apply)</span>
                    </label>
                    <div class="flex flex-wrap gap-2">
                        {% for supplement in ['Multivitamin', 'Protein Powder', 'Omega-3', 'Vitamin D', 'Iron', 'B12',
                        'Calcium', 'Magnesium', 'Probiotics'] %}
                        <label class="cursor-pointer">
                            <input type="checkbox" name="supplements" value="{{ supplement.lower().replace(' ', '_') }}"
                                class="peer sr-only">
                            <div
                                class="px-4 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300 bg-white/40 dark:bg-black/20 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all hover:bg-gray-50 dark:hover:bg-white/5">
                                {{ supplement }}
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Section 3: Goals & Targets -->
            <div id="section3" class="form-section p-8 lg:p-10 hidden animate-fade-in">
                <div class="flex items-center space-x-4 mb-8">
                    <div
                        class="w-12 h-12 bg-blue-100/50 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center border border-blue-200/50 dark:border-blue-800/30">
                        <i class="ph ph-target text-2xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 font-serif-accent">Goals &
                            Targets</h2>
                        <p class="text-gray-500 dark:text-gray-400">What would you like to achieve?</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Primary Goal -->
                    <div class="md:col-span-2">
                        <label for="goal_type" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Primary Goal <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <select id="goal_type" name="goal_type" required
                                class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                <option value="">Select your primary goal</option>
                                <option value="lose_weight_slow">Lose Weight (Slow & Sustainable)</option>
                                <option value="lose_weight_moderate">Lose Weight (Moderate)</option>
                                <option value="lose_weight_fast">Lose Weight (Fast)</option>
                                <option value="maintain_weight">Maintain Current Weight</option>
                                <option value="gain_weight_slow">Gain Weight (Slow)</option>
                                <option value="gain_weight_moderate">Gain Weight (Moderate)</option>
                                <option value="build_muscle">Build Muscle & Strength</option>
                                <option value="improve_health">Improve Overall Health</option>
                                <option value="manage_diabetes">Manage Diabetes</option>
                                <option value="lower_cholesterol">Lower Cholesterol</option>
                            </select>
                            <i
                                class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-lg"></i>
                        </div>
                    </div>

                    <!-- Target Weight -->
                    <div id="targetWeightDiv" class="hidden">
                        <label for="target_weight"
                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Target Weight
                        </label>
                        <div class="flex space-x-3">
                            <input type="number" id="target_weight" name="target_weight" min="50" max="1000" step="0.1"
                                class="input-glass flex-1 px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 text-gray-900 dark:text-gray-100"
                                placeholder="Target (lbs)">
                            <div
                                class="px-4 py-3 bg-gray-50 dark:bg-white/5 border border-gray-200 dark:border-gray-700 rounded-xl text-gray-600 dark:text-gray-300 font-medium flex items-center justify-center min-w-[3.5rem]">
                                lbs
                            </div>
                        </div>
                        <p class="text-xs font-mono text-gray-400 mt-2 ml-1">
                            Metric: <span id="targetWeightKg"
                                class="font-bold text-green-600 dark:text-green-400">-</span>
                        </p>
                    </div>

                    <!-- Timeline -->
                    <div>
                        <label for="timeline_weeks"
                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Timeline
                        </label>
                        <div class="relative">
                            <select id="timeline_weeks" name="timeline_weeks"
                                class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                <option value="">Select timeline</option>
                                <option value="4">4 weeks (1 month)</option>
                                <option value="8">8 weeks (2 months)</option>
                                <option value="12">12 weeks (3 months)</option>
                                <option value="16">16 weeks (4 months)</option>
                                <option value="24">24 weeks (6 months)</option>
                                <option value="52">1 year</option>
                            </select>
                            <i
                                class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-lg"></i>
                        </div>
                    </div>

                    <!-- Secondary Goals -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Secondary Goals
                            <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Select all that
                                apply)</span>
                        </label>
                        <div class="flex flex-wrap gap-2">
                            {% for goal in ['More energy', 'Better sleep', 'Clearer skin', 'Improved athletic
                            performance', 'Better digestion', 'Stress management', 'Improved focus', 'Better mood'] %}
                            <label class="cursor-pointer">
                                <input type="checkbox" name="secondary_goals"
                                    value="{{ goal.lower().replace(' ', '_') }}" class="peer sr-only">
                                <div
                                    class="px-4 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300 bg-white/40 dark:bg-black/20 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all hover:bg-gray-50 dark:hover:bg-white/5">
                                    {{ goal }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Nutritional Targets (Auto-calculated) -->
                    <div id="nutritionalTargets"
                        class="md:col-span-2 mt-2 p-6 bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-100 dark:border-green-800/30 rounded-2xl hidden">
                        <div class="flex items-center gap-2 mb-4">
                            <i class="ph ph-lightning text-green-600 dark:text-green-400"></i>
                            <h3 class="text-lg font-bold text-green-800 dark:text-green-200">Recommended Daily Targets
                            </h3>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center bg-white/60 dark:bg-black/20 rounded-xl p-3">
                                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="targetCalories">-
                                </div>
                                <div
                                    class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                                    Calories</div>
                            </div>
                            <div class="text-center bg-white/60 dark:bg-black/20 rounded-xl p-3">
                                <div class="text-xl font-bold text-gray-800 dark:text-gray-200" id="targetProtein">-
                                </div>
                                <div
                                    class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                                    Protein (g)</div>
                            </div>
                            <div class="text-center bg-white/60 dark:bg-black/20 rounded-xl p-3">
                                <div class="text-xl font-bold text-gray-800 dark:text-gray-200" id="targetCarbs">-</div>
                                <div
                                    class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                                    Carbs (g)</div>
                            </div>
                            <div class="text-center bg-white/60 dark:bg-black/20 rounded-xl p-3">
                                <div class="text-xl font-bold text-gray-800 dark:text-gray-200" id="targetFat">-</div>
                                <div
                                    class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                                    Fat (g)</div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 text-center opacity-80">
                            Based on your inputs. You can adjust these in settings later.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Section 4: Diet Preferences -->
            <div id="section4" class="form-section p-8 lg:p-10 hidden animate-fade-in">
                <div class="flex items-center space-x-4 mb-8">
                    <div
                        class="w-12 h-12 bg-purple-100/50 dark:bg-purple-900/30 rounded-2xl flex items-center justify-center border border-purple-200/50 dark:border-purple-800/30">
                        <i class="ph ph-fork-knife text-2xl text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 font-serif-accent">Diet
                            Preferences</h2>
                        <p class="text-gray-500 dark:text-gray-400">Customize your food choices</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- Diet Type -->
                    <div>
                        <label for="diet_type" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Preferred Diet Type
                        </label>
                        <div class="relative">
                            <select id="diet_type" name="diet_type"
                                class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                <option value="">Select diet type</option>
                                <option value="standard_american">Standard American Diet</option>
                                <option value="mediterranean">Mediterranean Diet</option>
                                <option value="ketogenic">Ketogenic (Keto)</option>
                                <option value="paleo">Paleo</option>
                                <option value="plant_based_vegan">Plant-Based Vegan</option>
                                <option value="vegetarian">Vegetarian</option>
                                <option value="pescatarian">Pescatarian</option>
                                <option value="flexitarian">Flexitarian</option>
                                <option value="intermittent_fasting_16_8">Intermittent Fasting (16:8)</option>
                                <option value="intermittent_fasting_18_6">Intermittent Fasting (18:6)</option>
                                <option value="dash_diet">DASH Diet</option>
                                <option value="low_carb">Low Carb</option>
                                <option value="gluten_free">Gluten-Free</option>
                                <option value="low_fodmap">Low FODMAP</option>
                                <option value="whole30">Whole30</option>
                                <option value="anti_inflammatory">Anti-Inflammatory</option>
                            </select>
                            <i
                                class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-lg"></i>
                        </div>
                    </div>

                    <!-- Food Allergies -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Food Allergies
                            <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Select all that
                                apply)</span>
                        </label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {% for allergy in constants.food_allergies %}
                            <label class="cursor-pointer">
                                <input type="checkbox" name="allergies" value="{{ allergy }}" class="peer sr-only">
                                <div
                                    class="p-3 rounded-xl border border-gray-200 dark:border-gray-700 text-center text-sm bg-white/40 dark:bg-black/20 text-gray-700 dark:text-gray-300 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500 transition-all hover:bg-red-50 dark:hover:bg-white/5 capitalize">
                                    {{ allergy }}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Food Restrictions -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Religious/Cultural Restrictions
                        </label>
                        <div class="flex flex-wrap gap-2">
                            {% for restriction in constants.food_restrictions %}
                            <label class="cursor-pointer">
                                <input type="checkbox" name="food_restrictions" value="{{ restriction }}"
                                    class="peer sr-only">
                                <div
                                    class="px-4 py-2 rounded-full border border-gray-200 dark:border-gray-700 text-sm bg-white/40 dark:bg-black/20 text-gray-700 dark:text-gray-300 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 transition-all hover:bg-orange-50 dark:hover:bg-white/5">
                                    {% if restriction == 'no_pork' %}No Pork
                                    {% elif restriction == 'no_beef' %}No Beef
                                    {% elif restriction == 'no_alcohol' %}No Alcohol
                                    {% elif restriction == 'organic_only' %}Organic Only
                                    {% else %}{{ restriction.title() }}
                                    {% endif %}
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Cooking & Lifestyle -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="cooking_skill"
                                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Cooking
                                Skill</label>
                            <div class="relative">
                                <select id="cooking_skill" name="cooking_skill"
                                    class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                    <option value="">Select level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                                <i
                                    class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div>
                            <label for="prep_time_limit"
                                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Max Prep
                                Time</label>
                            <div class="relative">
                                <select id="prep_time_limit" name="prep_time_limit"
                                    class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                    <option value="">Select time</option>
                                    <option value="15">15 mins</option>
                                    <option value="30">30 mins</option>
                                    <option value="45">45 mins</option>
                                    <option value="60">1 hour</option>
                                    <option value="90">1.5 hours</option>
                                    <option value="120">2+ hours</option>
                                </select>
                                <i
                                    class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div>
                            <label for="meal_timing_preference"
                                class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Timing</label>
                            <div class="relative">
                                <select id="meal_timing_preference" name="meal_timing_preference"
                                    class="input-glass w-full px-4 py-3 rounded-xl focus:ring-2 focus:ring-green-500/50 appearance-none text-gray-900 dark:text-gray-100">
                                    <option value="">Select preference</option>
                                    <option value="early_bird">Early Bird</option>
                                    <option value="normal">Normal</option>
                                    <option value="night_owl">Night Owl</option>
                                </select>
                                <i
                                    class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Student Lifestyle -->
            <div id="section5" class="form-section p-8 lg:p-10 hidden animate-fade-in">
                <div class="flex items-center space-x-4 mb-8">
                    <div
                        class="w-12 h-12 bg-orange-100/50 dark:bg-orange-900/30 rounded-2xl flex items-center justify-center border border-orange-200/50 dark:border-orange-800/30">
                        <i class="ph ph-graduation-cap text-2xl text-orange-600 dark:text-orange-400"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 font-serif-accent">Student
                            Lifestyle</h2>
                        <p class="text-gray-500 dark:text-gray-400">Tell us about your living situation</p>
                    </div>
                </div>

                <div class="space-y-8">
                    <!-- Living Situation -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Living Situation
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% for situation in ['Dorm with meal plan', 'Dorm with kitchen', 'Apartment', 'Living at
                            home'] %}
                            <label
                                class="relative flex items-center p-4 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-all group">
                                <input type="radio" name="living_situation"
                                    value="{{ situation.lower().replace(' ', '_') }}" class="peer sr-only">
                                <div
                                    class="w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded-full flex items-center justify-center peer-checked:bg-green-500 peer-checked:border-green-500 transition-colors mr-3">
                                    <div class="w-2.5 h-2.5 bg-white rounded-full opacity-0 peer-checked:opacity-100">
                                    </div>
                                </div>
                                <span class="text-gray-900 dark:text-gray-100 font-medium">{{ situation }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Budget -->
                    <div>
                        <label for="budget_per_day"
                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-4">
                            Daily Food Budget ($)
                        </label>
                        <div class="px-2">
                            <input type="range" id="budget_per_day" name="budget_per_day" min="5" max="50" value="20"
                                step="1"
                                class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-lg appearance-none cursor-pointer slider accent-green-500">
                            <div
                                class="flex justify-between text-xs font-bold text-gray-400 mt-2 uppercase tracking-wide">
                                <span>$5</span>
                                <span id="budgetValue" class="text-green-600 dark:text-green-400 text-lg">$20</span>
                                <span>$50+</span>
                            </div>
                        </div>
                    </div>

                    <!-- Meal Prep Preference -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Meal Prep Preference
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            {% for pref in ['Daily cooking', 'Batch Sunday prep', 'Grab-and-go', 'Mix of all'] %}
                            <label
                                class="relative flex items-center p-4 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 transition-all group">
                                <input type="radio" name="meal_prep_preference"
                                    value="{{ pref.lower().replace(' ', '_').replace('-', '_') }}" class="peer sr-only">
                                <div
                                    class="w-5 h-5 border-2 border-gray-300 dark:border-gray-600 rounded-full flex items-center justify-center peer-checked:bg-green-500 peer-checked:border-green-500 transition-colors mr-3">
                                    <div class="w-2.5 h-2.5 bg-white rounded-full opacity-0 peer-checked:opacity-100">
                                    </div>
                                </div>
                                <span class="text-gray-900 dark:text-gray-100 font-medium">{{ pref }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Class Schedule -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">
                            Typical Meal Times
                            <span class="text-xs font-normal text-gray-500 dark:text-gray-400 ml-2">(Optional)</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="breakfast_time"
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Breakfast</label>
                                <input type="time" id="breakfast_time" name="breakfast_time"
                                    class="input-glass w-full px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="lunch_time"
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Lunch</label>
                                <input type="time" id="lunch_time" name="lunch_time"
                                    class="input-glass w-full px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="dinner_time"
                                    class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Dinner</label>
                                <input type="time" id="dinner_time" name="dinner_time"
                                    class="input-glass w-full px-3 py-2 rounded-lg text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div
                class="flex flex-col-reverse sm:flex-row sm:justify-between items-center gap-4 p-8 border-t border-gray-200/50 dark:border-white/10 mt-auto bg-gray-50/50 dark:bg-black/20 backdrop-blur-sm rounded-b-3xl">
                <button type="button" id="prevBtn"
                    class="w-full sm:w-auto px-6 py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-white/80 dark:hover:bg-white/10 transition-all disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                    disabled>
                    <i class="ph ph-arrow-left mr-2"></i>
                    Previous
                </button>

                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button type="button" id="saveDraftBtn"
                        class="w-full sm:w-auto px-6 py-3 rounded-xl border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-400 hover:bg-white/80 dark:hover:bg-white/10 transition-all font-medium hidden sm:flex items-center justify-center">
                        <i class="ph ph-floppy-disk mr-2"></i>
                        Save Draft
                    </button>

                    <button type="button" id="nextBtn"
                        class="btn-primary w-full sm:w-auto px-8 py-3 rounded-xl flex items-center justify-center">
                        Next
                        <i class="ph ph-arrow-right ml-2"></i>
                    </button>

                    <button type="submit" id="submitBtn"
                        class="btn-primary w-full sm:w-auto px-8 py-3 rounded-xl flex items-center justify-center hidden">
                        <i class="ph ph-check mr-2"></i>
                        Complete Setup
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md"></div>
        <div class="relative max-w-md w-full mx-4">
            <div
                class="glass-panel rounded-3xl p-8 text-center max-w-sm mx-auto shadow-2xl border border-white/20 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-green-500/10 to-blue-500/10 opacity-50"></div>
                <div class="relative z-10">
                    <div
                        class="w-20 h-20 bg-gradient-to-br from-green-400 to-emerald-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-green-500/30">
                        <i class="ph ph-check text-4xl text-white"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2 font-serif-accent">Profile
                        Complete!</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-8 leading-relaxed">
                        Your personalized nutrition plan is ready. Let's start analyzing your meals!
                    </p>
                    <div class="space-y-3">
                        <a href="{{ url_for('index') }}"
                            class="btn-primary w-full py-3.5 rounded-xl flex items-center justify-center group shadow-lg shadow-green-500/20">
                            <i class="ph ph-camera text-lg mr-2 group-hover:scale-110 transition-transform"></i>
                            Start Analyzing
                        </a>
                        <a href="{{ url_for('profile.view_profile') }}"
                            class="w-full py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-white/5 text-gray-700 dark:text-gray-300 font-medium transition-all flex items-center justify-center">
                            View Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom slider styling */
    .slider {
        background: linear-gradient(to right, #10B981 0%, #10B981 var(--value, 30%), #E5E7EB var(--value, 30%), #E5E7EB 100%);
    }

    .dark .slider {
        background: linear-gradient(to right, #10B981 0%, #10B981 var(--value, 30%), #374151 var(--value, 30%), #374151 100%);
    }

    .slider::-webkit-slider-thumb {
        appearance: none;
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #10B981;
        cursor: pointer;
        border: 2px solid #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .slider::-moz-range-thumb {
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: #10B981;
        cursor: pointer;
        border: 2px solid #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Fix time input icon in dark mode */
    .dark input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let currentSection = 1;
        const totalSections = 5;

        // Get all form sections
        const sections = document.querySelectorAll('.form-section');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');

        // Unit conversion functions
        function updateHeightCm() {
            const feet = parseInt(document.getElementById('heightFeet').value) || 0;
            const inches = parseFloat(document.getElementById('heightInches').value) || 0;
            const totalInches = (feet * 12) + inches;
            const cm = Math.round(totalInches * 2.54);
            document.getElementById('heightCm').textContent = cm > 0 ? cm + ' cm' : '-';
            return cm;
        }

        function updateWeightKg() {
            const weightLbs = parseFloat(document.getElementById('weight').value) || 0;
            // Precise conversion for backend/math
            const preciseKg = weightLbs * 0.453592;
            // Display rounded to 1 decimal
            const displayKg = Math.round(preciseKg * 10) / 10;
            document.getElementById('weightKg').textContent = weightLbs > 0 ? displayKg + ' kg' : '-';
            return preciseKg;
        }

        function updateTargetWeightKg() {
            const weightLbs = parseFloat(document.getElementById('target_weight').value) || 0;
            // Precise conversion
            const preciseKg = weightLbs * 0.453592;
            // Display rounded
            const displayKg = Math.round(preciseKg * 10) / 10;
            document.getElementById('targetWeightKg').textContent = weightLbs > 0 ? displayKg + ' kg' : '-';
            return preciseKg;
        }

        // Budget slider
        const budgetSlider = document.getElementById('budget_per_day');
        const budgetValue = document.getElementById('budgetValue');

        function updateBudgetDisplay() {
            const value = budgetSlider.value;
            budgetValue.textContent = value >= 50 ? '$50+' : '$' + value;
            const percentage = ((value - 5) / (50 - 5)) * 100;
            budgetSlider.style.setProperty('--value', percentage + '%');
        }

        // Event listeners for calculations
        document.getElementById('heightFeet').addEventListener('change', updateHeightCm);
        document.getElementById('heightInches').addEventListener('input', updateHeightCm);
        document.getElementById('weight').addEventListener('input', updateWeightKg);
        document.getElementById('target_weight').addEventListener('input', function () {
            updateTargetWeightKg();
            calculateNutritionalNeeds();
        });
        // Removed weightUnit listener
        budgetSlider.addEventListener('input', updateBudgetDisplay);
        budgetSlider.addEventListener('input', updateBudgetDisplay);

        // Goal type change handler
        // Goal type change handler
        document.getElementById('goal_type').addEventListener('change', function () {
            const targetWeightDiv = document.getElementById('targetWeightDiv');
            const targetWeightInput = document.getElementById('target_weight');
            const weightGoals = ['lose_weight_slow', 'lose_weight_moderate', 'lose_weight_fast', 'gain_weight_slow', 'gain_weight_moderate'];

            if (weightGoals.includes(this.value)) {
                targetWeightDiv.classList.remove('hidden');
                targetWeightInput.setAttribute('required', '');
            } else {
                targetWeightDiv.classList.add('hidden');
                targetWeightInput.removeAttribute('required');
                targetWeightInput.value = ''; // Optional: Clear value when hidden
            }

            // Calculate nutritional needs when enough data is available
            calculateNutritionalNeeds();
        });

        // Calculate nutritional needs
        async function calculateNutritionalNeeds() {
            const age = document.getElementById('age').value;
            const biologicalSex = document.querySelector('input[name="biological_sex"]:checked')?.value;
            const activityLevel = document.getElementById('activity_level').value;
            const goalType = document.getElementById('goal_type').value;
            const heightCm = updateHeightCm();
            const weightKg = updateWeightKg();

            if (age && biologicalSex && activityLevel && goalType && heightCm > 0 && weightKg > 0) {
                try {
                    const response = await fetch('/profile/api/calculate-needs', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            age: parseInt(age),
                            biological_sex: biologicalSex,
                            activity_level: activityLevel,
                            goal_type: goalType,
                            height_cm: heightCm,
                            weight_kg: weightKg,
                            target_weight_kg: updateTargetWeightKg(),
                            timeline_weeks: parseInt(document.getElementById('timeline_weeks').value) || 0
                        })
                    });

                    const data = await response.json();
                    if (data.success) {
                        const calc = data.calculations;
                        document.getElementById('targetCalories').textContent = calc.target_calories;
                        document.getElementById('targetProtein').textContent = calc.protein_grams;
                        document.getElementById('targetCarbs').textContent = calc.carbs_grams;
                        document.getElementById('targetFat').textContent = calc.fat_grams;
                        document.getElementById('nutritionalTargets').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error calculating nutritional needs:', error);
                }
            }
        }

        // Add listeners for calculation triggers
        ['age', 'activity_level'].forEach(id => {
            document.getElementById(id).addEventListener('change', calculateNutritionalNeeds);
        });
        document.querySelectorAll('input[name="biological_sex"]').forEach(radio => {
            radio.addEventListener('change', calculateNutritionalNeeds);
        });
        document.getElementById('timeline_weeks').addEventListener('change', calculateNutritionalNeeds);

        function showSection(n) {
            sections.forEach((section, index) => {
                section.classList.toggle('hidden', index !== n - 1);
            });

            // Update progress
            const progress = (n / totalSections) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = `Step ${n} of ${totalSections}`;

            // Update buttons
            prevBtn.disabled = n === 1;
            nextBtn.classList.toggle('hidden', n === totalSections);
            submitBtn.classList.toggle('hidden', n !== totalSections);

            currentSection = n;
        }

        function validateSection(n) {
            const section = sections[n - 1];
            const requiredInputs = section.querySelectorAll('input[required], select[required]');

            for (let input of requiredInputs) {
                if (!input.value || (input.type === 'radio' && !section.querySelector(`input[name="${input.name}"]:checked`))) {
                    input.focus();
                    showNotification('Please fill in all required fields.', 'error');
                    return false;
                }
            }
            return true;
        }

        // Navigation
        nextBtn.addEventListener('click', function () {
            if (validateSection(currentSection)) {
                if (currentSection < totalSections) {
                    showSection(currentSection + 1);
                }
            }
        });

        prevBtn.addEventListener('click', function () {
            if (currentSection > 1) {
                showSection(currentSection - 1);
            }
        });

        // Save draft functionality
        document.getElementById('saveDraftBtn').addEventListener('click', function () {
            saveProfile(true);
        });

        // Form submission
        document.getElementById('profileForm').addEventListener('submit', function (e) {
            e.preventDefault();
            saveProfile(false);
        });

        async function saveProfile(isDraft = false) {
            const formData = new FormData(document.getElementById('profileForm'));

            // Calculate target weight in kg (Assume LBS input)
            let targetWeightKg = null;
            const rawTargetWeight = parseFloat(formData.get('target_weight'));

            if (rawTargetWeight) {
                targetWeightKg = rawTargetWeight * 0.453592; // Use precise conversion
            }

            // Convert FormData to structured object
            const data = {
                basic_info: {
                    age: formData.get('age') ? parseInt(formData.get('age')) : null,
                    height_cm: updateHeightCm(),
                    weight_kg: updateWeightKg(), // This already returns calculated KG from LBS
                    biological_sex: formData.get('biological_sex'),
                    activity_level: formData.get('activity_level'),
                    health_conditions: formData.getAll('health_conditions'),
                    medications: formData.get('medications'),
                    supplements: formData.getAll('supplements')
                },
                goals: {
                    goal_type: formData.get('goal_type'),
                    target_weight_kg: targetWeightKg,
                    timeline_weeks: formData.get('timeline_weeks') ? parseInt(formData.get('timeline_weeks')) : null,
                    secondary_goals: formData.getAll('secondary_goals'),
                    // These will be calculated on the backend
                    daily_calories: null,
                    protein_grams: null,
                    carbs_grams: null,
                    fat_grams: null,
                    fiber_grams: null,
                    sodium_mg: null,
                    sugar_grams: null
                },
                preferences: {
                    diet_type: formData.get('diet_type'),
                    allergies: formData.getAll('allergies'),
                    food_restrictions: formData.getAll('food_restrictions'),
                    meal_timing_preference: formData.get('meal_timing_preference'),
                    cooking_skill: formData.get('cooking_skill'),
                    prep_time_limit: formData.get('prep_time_limit') ? parseInt(formData.get('prep_time_limit')) : null,
                    budget_per_meal: formData.get('budget_per_day') ? parseFloat(formData.get('budget_per_day')) / 3 : null, // Convert daily to per meal
                    living_situation: formData.get('living_situation'),
                    meal_prep_preference: formData.get('meal_prep_preference'),
                    class_schedule: {
                        breakfast_time: formData.get('breakfast_time'),
                        lunch_time: formData.get('lunch_time'),
                        dinner_time: formData.get('dinner_time')
                    }
                }
            };

            try {
                const response = await fetch('/profile/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    if (isDraft) {
                        showNotification('Profile draft saved successfully!', 'success');
                    } else {
                        // Show success modal
                        document.getElementById('successModal').classList.remove('hidden');
                        document.getElementById('successModal').classList.add('flex');
                    }
                } else {
                    showNotification(result.error || 'Error saving profile', 'error');
                }
            } catch (error) {
                console.error('Error saving profile:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        // Load existing data if available
        async function loadExistingData() {
            try {
                const response = await fetch('/profile/api/load');
                const result = await response.json();

                if (result.success && result.data) {
                    // Populate form with existing data
                    const { profile, goals, preferences } = result.data;

                    if (profile) {
                        // Basic info
                        if (profile.age) document.getElementById('age').value = profile.age;
                        if (profile.height_cm) {
                            const totalInches = profile.height_cm / 2.54;
                            const feet = Math.floor(totalInches / 12);
                            // Keep decimal precision for inches (e.g. 2.5), round to 1 decimal place to avoid float artifacts
                            const inches = Math.round((totalInches % 12) * 10) / 10;
                            document.getElementById('heightFeet').value = feet;
                            document.getElementById('heightInches').value = inches;
                            updateHeightCm();
                        }
                        if (profile.weight_kg) {
                            const weightLbs = profile.weight_kg * 2.20462;
                            // Round to 1 decimal place to avoid 199.1 artifact
                            document.getElementById('weight').value = Math.round(weightLbs * 10) / 10;
                            updateWeightKg();
                        }
                        if (profile.biological_sex) {
                            document.querySelector(`input[name="biological_sex"][value="${profile.biological_sex}"]`).checked = true;
                        }
                        if (profile.activity_level) {
                            document.getElementById('activity_level').value = profile.activity_level;
                        }
                        if (profile.health_conditions) {
                            profile.health_conditions.forEach(condition => {
                                const checkbox = document.querySelector(`input[name="health_conditions"][value="${condition}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        if (profile.medications) {
                            document.getElementById('medications').value = profile.medications;
                        }
                        if (profile.supplements) {
                            profile.supplements.forEach(supplement => {
                                const checkbox = document.querySelector(`input[name="supplements"][value="${supplement}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }

                    if (goals) {
                        if (goals.goal_type) document.getElementById('goal_type').value = goals.goal_type;
                        if (goals.target_weight_kg) {
                            // Always display in lbs, handle precision
                            // 2.20462 * kg
                            const weightLbs = goals.target_weight_kg * 2.20462;
                            // Round to 1 decimal place to match input step
                            document.getElementById('target_weight').value = Math.round(weightLbs * 10) / 10;
                            updateTargetWeightKg();
                        }
                        if (goals.timeline_weeks) document.getElementById('timeline_weeks').value = goals.timeline_weeks;
                        if (goals.secondary_goals) {
                            goals.secondary_goals.forEach(goal => {
                                const checkbox = document.querySelector(`input[name="secondary_goals"][value="${goal}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }

                    if (preferences) {
                        if (preferences.diet_type) document.getElementById('diet_type').value = preferences.diet_type;
                        if (preferences.allergies) {
                            preferences.allergies.forEach(allergy => {
                                const checkbox = document.querySelector(`input[name="allergies"][value="${allergy}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        if (preferences.food_restrictions) {
                            preferences.food_restrictions.forEach(restriction => {
                                const checkbox = document.querySelector(`input[name="food_restrictions"][value="${restriction}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        if (preferences.cooking_skill) document.getElementById('cooking_skill').value = preferences.cooking_skill;
                        if (preferences.prep_time_limit) document.getElementById('prep_time_limit').value = preferences.prep_time_limit;
                        if (preferences.meal_timing_preference) document.getElementById('meal_timing_preference').value = preferences.meal_timing_preference;
                        if (preferences.budget_per_meal) {
                            const dailyBudget = Math.round(preferences.budget_per_meal * 3); // Convert back to daily
                            document.getElementById('budget_per_day').value = dailyBudget;
                            updateBudgetDisplay();
                        }
                        if (preferences.living_situation) {
                            const radio = document.querySelector(`input[name="living_situation"][value="${preferences.living_situation}"]`);
                            if (radio) radio.checked = true;
                        }
                        if (preferences.meal_prep_preference) {
                            const radio = document.querySelector(`input[name="meal_prep_preference"][value="${preferences.meal_prep_preference}"]`);
                            if (radio) radio.checked = true;
                        }
                        if (preferences.class_schedule) {
                            if (preferences.class_schedule.breakfast_time) document.getElementById('breakfast_time').value = preferences.class_schedule.breakfast_time;
                            if (preferences.class_schedule.lunch_time) document.getElementById('lunch_time').value = preferences.class_schedule.lunch_time;
                            if (preferences.class_schedule.dinner_time) document.getElementById('dinner_time').value = preferences.class_schedule.dinner_time;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading existing data:', error);
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg border max-w-sm transition-all duration-300 transform translate-x-full opacity-0';

            if (type === 'success') {
                notification.classList.add('bg-green-50', 'dark:bg-green-950/30', 'border-green-200', 'dark:border-green-800', 'text-green-800', 'dark:text-green-200');
                notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="ph ph-check-circle text-green-500 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            } else if (type === 'error') {
                notification.classList.add('bg-red-50', 'dark:bg-red-950/30', 'border-red-200', 'dark:border-red-800', 'text-red-800', 'dark:text-red-200');
                notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="ph ph-warning text-red-500 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
            }

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
                notification.classList.add('translate-x-0', 'opacity-100');
            }, 100);

            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize
        updateBudgetDisplay();
        loadExistingData();
        showSection(1);
    });
</script>
{% endblock %}