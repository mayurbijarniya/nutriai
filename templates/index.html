{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-16">

    <!-- Hero Section -->
    <div class="text-center pt-8 md:pt-16 space-y-6">
        <div
            class="inline-flex items-center space-x-2 bg-green-100/50 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-4 py-1.5 rounded-full text-xs font-semibold tracking-wide uppercase shadow-sm border border-green-200/50 dark:border-green-800/50 backdrop-blur-sm">
            <span class="relative flex h-2 w-2">
                <span
                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
            </span>
            <span>AI-Powered 2.0</span>
        </div>

        <h1 class="text-5xl md:text-7xl font-bold tracking-tight text-gray-900 dark:text-white leading-[1.1]">
            Your Personal <br />
            <span
                class="font-serif-accent italic bg-gradient-to-r from-emerald-500 to-teal-500 bg-clip-text text-transparent pr-2">Nutritionist</span>
            in Your Pocket
        </h1>

        <p class="text-lg md:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto leading-relaxed">
            Upload a meal photo and let our advanced AI analyze macros, ingredients, and compatibility with your diet
            goals instantly.
        </p>
    </div>

    <!-- Main Glass Interface -->
    <div class="relative">
        <!-- Abstract Glow Behind -->
        <div
            class="absolute -top-10 -left-10 w-72 h-72 bg-purple-300/30 dark:bg-purple-900/20 rounded-full blur-[80px] -z-10 animate-pulse">
        </div>
        <div
            class="absolute -bottom-10 -right-10 w-72 h-72 bg-green-300/30 dark:bg-green-900/20 rounded-full blur-[80px] -z-10 animate-pulse delay-700">
        </div>

        <div class="glass-panel rounded-[2rem] p-1 shadow-2xl overflow-hidden">
            <div class="bg-white/40 dark:bg-black/20 rounded-[1.8rem] h-full">
                <!-- Chat Header -->
                <div class="border-b border-gray-200/50 dark:border-gray-700/50 p-5 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div
                            class="w-12 h-12 rounded-2xl bg-gradient-to-tr from-green-400 to-emerald-600 flex items-center justify-center shadow-lg text-white">
                            <i class="ph ph-camera-plus text-xl"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900 dark:text-white text-lg">AI Analysis</h3>
                            <div
                                class="flex items-center space-x-1.5 text-xs text-green-600 dark:text-green-400 font-medium">
                                <i class="ph ph-lightning-fill"></i>
                                <span>Online & Ready</span>
                            </div>
                        </div>
                    </div>

                    <!-- Diet Dropdown (Glass Style) -->
                    <div class="relative z-20">
                        <button id="dietDropdownBtn" type="button"
                            class="group flex items-center space-x-2.5 bg-white/60 dark:bg-gray-800/60 hover:bg-white dark:hover:bg-gray-800 transition-all border border-gray-200/50 dark:border-gray-700/50 rounded-xl px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm">
                            <span id="selectedDietIcon" class="text-lg">üçΩÔ∏è</span>
                            <span id="selectedDietText">Standard American</span>
                            <i class="ph ph-caret-down text-gray-400 group-hover:text-gray-600 transition-colors"></i>
                        </button>

                        <div id="dietDropdown"
                            class="hidden absolute right-0 mt-2 w-72 glass-panel rounded-2xl shadow-xl z-50 overflow-hidden transform origin-top-right transition-all">
                            <div
                                class="p-2 bg-gray-50/50 dark:bg-gray-900/50 border-b border-gray-100 dark:border-gray-700/50">
                                <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2">Select
                                    Goal</span>
                            </div>
                            <div id="dietDropdownList" class="max-h-80 overflow-y-auto p-1 space-y-0.5">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Area -->
                <div id="chatMessages" class="h-[400px] overflow-y-auto p-6 space-y-6 scroll-smooth">
                    <!-- Intro Message -->
                    <div class="flex items-start gap-4 max-w-[90%] chat-message">
                        <div
                            class="w-10 h-10 rounded-full bg-gradient-to-tr from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-md flex-shrink-0 mt-1">
                            <i class="ph ph-robot text-lg"></i>
                        </div>
                        <div
                            class="glass-panel bg-white/60 dark:bg-gray-800/60 rounded-2xl rounded-tl-none p-4 shadow-sm text-gray-800 dark:text-gray-200 text-sm leading-relaxed border-0">
                            Hi! I'm your AI nutritionist. Upload a photo of your meal to get started.
                            <br>I can identify ingredients, estimate calories, and give you health tips based on your
                            diet!
                        </div>
                    </div>
                </div>

                <!-- Input Area (Bottom) -->
                <div class="p-5 bg-white/30 dark:bg-gray-900/30 border-t border-gray-200/50 dark:border-gray-700/50">
                    <form id="analysisForm" enctype="multipart/form-data" class="space-y-4">

                        <!-- Upload Tabs (Minimal) -->
                        <div class="flex space-x-4 mb-2">
                            <button type="button" id="uploadTab"
                                class="text-sm font-medium text-green-600 dark:text-green-400 border-b-2 border-green-500 pb-1 transition-colors">Upload
                                File</button>
                            <button type="button" id="urlTab"
                                class="text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 pb-1 transition-colors">Image
                                URL</button>
                        </div>

                        <!-- Drop Zone -->
                        <div id="uploadContent" class="relative group">
                            <div id="fileUpload">
                                <input type="file" id="imageFile" name="image_file" accept="image/*" class="hidden">
                                <div id="dropZone"
                                    class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-2xl p-8 hover:border-green-500 dark:hover:border-green-500 hover:bg-green-50/30 dark:hover:bg-green-900/10 transition-all cursor-pointer text-center group-hover:scale-[0.995]">
                                    <div
                                        class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 mb-3 group-hover:text-green-500 transition-colors">
                                        <i class="ph ph-cloud-arrow-up text-2xl"></i>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-300 font-medium">Click to browse or
                                        drag image here</p>
                                    <p class="text-xs text-gray-400 mt-1">JPG, PNG, WebP up to 16MB</p>
                                </div>
                            </div>

                            <!-- URL Input -->
                            <div id="urlInput" class="hidden">
                                <div class="flex gap-2">
                                    <input type="url" name="image_url" placeholder="Paste image link here..."
                                        class="flex-1 input-glass rounded-xl px-4 py-3 text-sm text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 shadow-sm">
                                    <button type="button" id="pasteUrl"
                                        class="px-5 py-3 rounded-xl bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300 font-medium text-sm transition-colors border border-gray-200 dark:border-gray-700">
                                        Paste
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Context Options (Accordion style) -->
                        <details class="group">
                            <summary
                                class="flex items-center justify-between cursor-pointer text-xs font-medium uppercase tracking-wider text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors py-2 select-none">
                                <span>Advanced Options (Context & Prefs)</span>
                                <i class="ph ph-caret-down group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div
                                class="pt-3 pb-2 grid grid-cols-1 md:grid-cols-2 gap-4 animate-in slide-in-from-top-2 duration-200">
                                <!-- Meal Context -->
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1.5">Meal Type</label>
                                    <div class="relative">
                                        <select name="meal_context"
                                            class="w-full appearance-none input-glass rounded-xl px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 shadow-sm cursor-pointer">
                                            <option value="">No specific context</option>
                                            <option value="breakfast">Breakfast</option>
                                            <option value="lunch">Lunch</option>
                                            <option value="dinner">Dinner</option>
                                            <option value="pre_workout">Pre-Workout</option>
                                            <option value="post_workout">Post-Workout</option>
                                            <option value="snack">Snack</option>
                                            <option value="cheat_meal">Cheat Meal</option>
                                        </select>
                                        <i
                                            class="ph ph-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                                    </div>
                                </div>
                                <!-- Prefs -->
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1.5">Quick Notes</label>
                                    <input type="text" name="user_preferences"
                                        placeholder="e.g. 'I'm allergic to nuts' or 'Low carb'"
                                        class="w-full input-glass rounded-xl px-4 py-2.5 text-sm text-gray-700 dark:text-gray-200 shadow-sm">
                                </div>
                            </div>
                        </details>

                        <!-- Usage Badge -->
                        <div id="usageBadge"
                            class="hidden p-3 rounded-xl text-xs bg-red-50/50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300 flex items-center justify-center space-x-2">
                            <!-- Populated by JS with limits -->
                        </div>

                        <!-- Action Button -->
                        <button type="submit" id="analyzeBtn"
                            class="w-full relative overflow-hidden group btn-primary rounded-xl py-4 font-bold text-sm uppercase tracking-wide shadow-lg hover:shadow-green-500/20 transition-all">
                            <div
                                class="absolute inset-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent -translate-x-full group-hover:animate-[shimmer_1.5s_infinite]">
                            </div>
                            <span class="relative flex items-center justify-center space-x-2">
                                <i class="ph ph-sparkle-fill text-green-400"></i>
                                <span>Analyze Meal</span>
                            </span>
                        </button>

                        <!-- Loading State -->
                        <div id="loadingState" class="hidden text-center py-2">
                            <div
                                class="inline-flex items-center space-x-3 px-4 py-2 rounded-full bg-white/50 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700 backdrop-blur-sm shadow-sm">
                                <svg class="animate-spin h-4 w-4 text-green-500" xmlns="http://www.w3.org/2000/svg"
                                    fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Analyzing<span
                                        class="loading-dots"></span></span>
                            </div>
                        </div>

                        <input type="hidden" id="dietGoal" name="diet_goal" value="standard_american">
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Anchor -->
    <div id="resultsSection" class="hidden scroll-mt-28">
        <div class="flex items-center space-x-4 mb-6">
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-700 to-transparent">
            </div>
            <span class="font-serif-accent text-2xl italic text-gray-400">Analysis Results</span>
            <div class="h-px flex-1 bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-700 to-transparent">
            </div>
        </div>

        <div id="analysisResult" class="glass-panel rounded-[2rem] p-8 md:p-10 shadow-xl">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Features Grid (Glass Cards) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 px-2">
        {% for feature in [
        {'icon': 'ph-sun-dim', 'color': 'text-amber-500', 'title': 'Perfect Lighting', 'desc': 'Natural light helps AI
        see details clearly.'},
        {'icon': 'ph-frame-corners', 'color': 'text-blue-500', 'title': 'Full Frame', 'desc': 'Capture the entire plate
        from above.'},
        {'icon': 'ph-fork-knife', 'color': 'text-purple-500', 'title': 'Utensils Context', 'desc': 'Helps estimate
        portion sizes accurately.'},
        {'icon': 'ph-list-magnifying-glass', 'color': 'text-rose-500', 'title': 'Visible Ingredients', 'desc': 'Ensure
        key components aren\'t hidden.'}
        ] %}
        <div
            class="glass-panel p-6 rounded-2xl flex flex-col items-center text-center transition-all duration-300 hover:-translate-y-2 hover:shadow-lg group">
            <div
                class="w-12 h-12 rounded-full bg-gray-50 dark:bg-white/5 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <i class="ph {{ feature.icon }} text-2xl {{ feature.color }}"></i>
            </div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-1">{{ feature.title }}</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 leading-snug">{{ feature.desc }}</p>
        </div>
        {% endfor %}
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    // Check for marked
    if (typeof marked === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        document.head.appendChild(s);
    }

    document.addEventListener('DOMContentLoaded', function () {
        // --- UI Interactions ---

        // Tab Switching
        const uploadTab = document.getElementById('uploadTab');
        const urlTab = document.getElementById('urlTab');
        const fileUpload = document.getElementById('fileUpload');
        const urlInput = document.getElementById('urlInput');

        function switchTab(mode) {
            if (mode === 'file') {
                uploadTab.classList.add('text-green-600', 'dark:text-green-400', 'border-b-2', 'border-green-500');
                uploadTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                urlTab.classList.remove('text-green-600', 'dark:text-green-400', 'border-b-2', 'border-green-500');
                urlTab.classList.add('text-gray-500', 'dark:text-gray-400');

                fileUpload.classList.remove('hidden');
                urlInput.classList.add('hidden');
            } else {
                urlTab.classList.add('text-green-600', 'dark:text-green-400', 'border-b-2', 'border-green-500');
                urlTab.classList.remove('text-gray-500', 'dark:text-gray-400');
                uploadTab.classList.remove('text-green-600', 'dark:text-green-400', 'border-b-2', 'border-green-500');
                uploadTab.classList.add('text-gray-500', 'dark:text-gray-400');

                urlInput.classList.remove('hidden');
                fileUpload.classList.add('hidden');
            }
        }

        uploadTab.addEventListener('click', () => switchTab('file'));
        urlTab.addEventListener('click', () => switchTab('url'));

        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('imageFile');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-green-500', 'bg-green-50/50', 'dark:bg-green-900/20');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-green-500', 'bg-green-50/50', 'dark:bg-green-900/20');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-green-500', 'bg-green-50/50', 'dark:bg-green-900/20');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) return;
            addUserMessage(`Uploaded: ${file.name}`);

            // Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewId = 'img-' + Date.now();
                const html = `
                <div class="relative w-full max-w-sm rounded-2xl overflow-hidden glass-panel">
                    <img src="${e.target.result}" class="w-full h-48 object-cover">
                    <div class="absolute bottom-0 inset-x-0 bg-black/50 backdrop-blur-sm p-2 text-white text-xs truncate">
                        ${file.name}
                    </div>
                </div>
            `;
                addMediaMessage('user', html);
            }
            reader.readAsDataURL(file);
        }

        // Paste URL
        const pasteBtn = document.getElementById('pasteUrl');
        if (pasteBtn) {
            pasteBtn.addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (text && text.startsWith('http')) {
                        document.querySelector('input[name="image_url"]').value = text;
                        addUserMessage(`Image URL: ${text}`);
                    }
                } catch (e) { }
            });
        }

        // --- Chat & Logic ---
        const chatContainer = document.getElementById('chatMessages');

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = "flex items-start justify-end gap-4 max-w-[90%] ml-auto chat-message";
            div.innerHTML = `
            <div class="bg-blue-600 text-white rounded-2xl rounded-tr-none p-4 shadow-md text-sm leading-relaxed">
                ${text}
            </div>
             <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center flex-shrink-0 mt-1">
                <i class="ph ph-user text-gray-500 dark:text-gray-300"></i>
            </div>
        `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(text) {
            const div = document.createElement('div');
            div.className = "flex items-start gap-4 max-w-[90%] chat-message";
            div.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-green-500 to-emerald-600 flex items-center justify-center text-white shadow-md flex-shrink-0 mt-1">
                <i class="ph ph-robot text-lg"></i>
            </div>
            <div class="glass-panel bg-white/60 dark:bg-gray-800/60 rounded-2xl rounded-tl-none p-4 shadow-sm text-gray-800 dark:text-gray-200 text-sm leading-relaxed border-0">
                ${text}
            </div>
        `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addMediaMessage(role, htmlContent) {
            const div = document.createElement('div');
            if (role === 'user') {
                div.className = "flex items-start justify-end gap-4 max-w-[90%] ml-auto chat-message";
                div.innerHTML = `
                ${htmlContent}
                <div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center flex-shrink-0 mt-1">
                    <i class="ph ph-user text-gray-500 dark:text-gray-300"></i>
                </div>
             `;
            }
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        // --- Data Loading (Diets) ---
        const dietGoalInput = document.getElementById('dietGoal');
        const dietDropdownBtn = document.getElementById('dietDropdownBtn');
        const dietDropdown = document.getElementById('dietDropdown');
        const dietDropdownList = document.getElementById('dietDropdownList');
        const selectedDietIcon = document.getElementById('selectedDietIcon');
        const selectedDietText = document.getElementById('selectedDietText');

        // Toggle
        dietDropdownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dietDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!dietDropdown.contains(e.target) && !dietDropdownBtn.contains(e.target)) {
                dietDropdown.classList.add('hidden');
            }
        });

        async function loadDiets() {
            try {
                const res = await fetch('/profile/api/diets');
                const data = await res.json();
                if (data.success) {
                    renderDiets(data.diets);
                }
            } catch (e) { console.error(e) }
        }

        const IS_AUTHENTICATED = document.body.dataset.authenticated === 'true';

        function emojiFor(slug) {
            const map = {
                'standard_american': 'üçΩÔ∏è', 'mediterranean': 'ü´í', 'ketogenic': 'ü•ë',
                'paleo': 'ü•©', 'plant_based_vegan': 'üå±', 'vegetarian': 'ü•¶',
                'pescatarian': 'üêü', 'dash_diet': 'üßÇ',
                'flexitarian': 'ü•ó', 'gluten_free': 'üåæ',
                'whole30': 'üçé', 'anti_inflammatory': 'ü´ê',
                'intermittent_fasting_16_8': '‚è≥',
                'intermittent_fasting_18_6': '‚è≥',
                'low_fodmap': 'ü•ù', 'low_carb': '‚öñÔ∏è'
            };
            return map[slug] || 'üçΩÔ∏è';
        }

        function renderDiets(diets) {
            let displayDiets = diets;
            let showSignIn = false;

            if (!IS_AUTHENTICATED) {
                // Show only first diet (Standard American) and prompt
                displayDiets = diets.slice(0, 1);
                showSignIn = true;
            }

            let html = displayDiets.map(d => `
            <button type="button" data-slug="${d.slug}" class="w-full flex items-center space-x-3 px-4 py-2 hover:bg-green-50 dark:hover:bg-green-900/20 text-left transition-colors group">
                <span class="text-xl">${emojiFor(d.slug)}</span>
                <div>
                     <p class="text-sm font-medium text-gray-700 dark:text-gray-200 group-hover:text-green-700 dark:group-hover:text-green-400">${d.label}</p>
                </div>
            </button>
            `).join('');

            if (showSignIn) {
                html += `
                <div class="px-4 py-3 border-t border-gray-100 dark:border-gray-800 text-center bg-gray-50/50 dark:bg-black/20">
                    <p class="text-xs text-gray-500 mb-2">Want more options?</p>
                    <a href="{{ url_for('auth.login') }}" class="block w-full py-1.5 rounded-lg bg-green-500 text-white text-xs font-bold hover:bg-green-600 transition-colors shadow-sm">
                        Sign in to see all diets
                    </a>
                </div>
                `;
            }

            dietDropdownList.innerHTML = html;

            // Handlers
            dietDropdownList.querySelectorAll('button[data-slug]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const slug = btn.dataset.slug;
                    const label = btn.querySelector('p').innerText;

                    dietGoalInput.value = slug;
                    selectedDietIcon.textContent = emojiFor(slug);
                    selectedDietText.textContent = label;
                    dietDropdown.classList.add('hidden');

                    addBotMessage(`Goal updated to <b>${label}</b>. I'll analyze your meals with this focus.`);
                });
            });

            // Set default if exists
            if (dietsData.length === 0) dietsData = diets; // Cache
            restoreUserPref();
        }

        let dietsData = [];
        async function restoreUserPref() {
            try {
                const res = await fetch('/profile/api/load');
                const data = await res.json();
                if (data.success && data.data.preferences?.diet_type) {
                    const slug = data.data.preferences.diet_type;
                    dietGoalInput.value = slug;
                    // Update UI look
                    selectedDietIcon.textContent = emojiFor(slug);
                    // Find label if possible
                    const btn = dietDropdownList.querySelector(`button[data-slug="${slug}"]`);
                    if (btn) selectedDietText.textContent = btn.querySelector('p').innerText;
                }
            } catch (_) { }
        }

        loadDiets();
        loadUsage();

        // --- Analysis Actions ---
        const form = document.getElementById('analysisForm');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingState = document.getElementById('loadingState');
        const resultsSection = document.getElementById('resultsSection');
        const analysisResult = document.getElementById('analysisResult');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // UI State: Loading
            analyzeBtn.classList.add('hidden');
            loadingState.classList.remove('hidden');
            addBotMessage("Analysing your meal... this usually takes about 10 seconds.");

            try {
                // --- Client-Side Compression Logic ---
                const fileInput = form.querySelector('input[type="file"]');
                let file = fileInput.files[0];

                if (file && file.type.startsWith('image/')) {
                    addBotMessage("Optimizing image for upload...");
                    try {
                        // Compress logic
                        const compressedBlob = await new Promise((resolve, reject) => {
                            const img = new Image();
                            img.src = URL.createObjectURL(file);
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                let width = img.width;
                                let height = img.height;

                                // Max dimension 1280px (plenty for analysis)
                                const MAX_SIZE = 1280;
                                if (width > height) {
                                    if (width > MAX_SIZE) {
                                        height *= MAX_SIZE / width;
                                        width = MAX_SIZE;
                                    }
                                } else {
                                    if (height > MAX_SIZE) {
                                        width *= MAX_SIZE / height;
                                        height = MAX_SIZE;
                                    }
                                }

                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);

                                // Compress to JPEG 0.8 quality
                                canvas.toBlob((blob) => {
                                    resolve(blob);
                                }, 'image/jpeg', 0.8);
                            };
                            img.onerror = reject;
                        });

                        // Replace file in FormData
                        file = new File([compressedBlob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", { type: 'image/jpeg' });
                        console.log(`Compressed image size: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
                    } catch (err) {
                        console.warn('Compression failed, falling back to original', err);
                    }
                }

                const formData = new FormData(form);
                if (file) formData.set('image_file', file); // Update formdata with compressed file

                const res = await fetch('/api/analyze-with-profile', { method: 'POST', body: formData });
                const data = await res.json();

                // UI State: Done
                analyzeBtn.classList.remove('hidden');
                loadingState.classList.add('hidden');

                if (data.error) {
                    addBotMessage(`‚ö†Ô∏è Error: ${data.message || data.error}`);
                } else {
                    renderResults(data);
                    loadUsage(); // Refresh limits
                }

            } catch (err) {
                analyzeBtn.classList.remove('hidden');
                loadingState.classList.add('hidden');
                addBotMessage("‚ö†Ô∏è Network error. Please try again.");
            }
        });

        function renderResults(data) {
            addBotMessage("Analysis complete! Check the detailed report below.");
            resultsSection.classList.remove('hidden');

            // Parse Markdown
            let html = data.analysis;
            if (typeof marked !== 'undefined') {
                html = marked.parse(data.analysis);
            }

            analysisResult.innerHTML = `
            <div class="prose prose-glass max-w-none">
                ${html}
            </div>
        `;

            // Smooth scroll
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadUsage() {
            try {
                const res = await fetch('/api/usage');
                const data = await res.json();
                const badge = document.getElementById('usageBadge');

                if (data.usage?.analyses) {
                    const { current, limit } = data.usage.analyses;
                    if (current >= limit || data.user_type === 'guest') {
                        badge.classList.remove('hidden');
                        badge.innerHTML = `<i class="ph ph-warning"></i> <span>Daily Usage: ${current}/${limit} (Guest Mode)</span>`;
                    }
                }
            } catch (_) { }
        }
    });
</script>
{% endblock %}