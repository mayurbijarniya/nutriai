{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero Section -->
    <div class="text-center mb-12">
        <div class="inline-flex items-center space-x-2 bg-green-50 dark:bg-green-950/50 text-green-600 dark:text-green-400 px-4 py-2 rounded-full text-sm font-medium mb-6">
            <i class="ph ph-robot"></i>
            <span>AI-Powered Nutrition Analysis</span>
        </div>
        
        <h1 class="text-4xl sm:text-5xl font-bold tracking-tight mb-4 bg-gradient-to-r from-green-800 via-emerald-700 to-green-800 bg-clip-text text-transparent">
            AI Diet Designer
        </h1>
        <p class="text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed">
            Upload your meal photo and get personalized nutrition analysis and recommendations
        </p>
        
        <div class="flex flex-wrap justify-center gap-3 mt-8">
            <!--<div class="inline-flex items-center space-x-2 bg-green-50 dark:bg-green-950/30 text-green-600 dark:text-green-400 px-3 py-1.5 rounded-lg text-sm border border-green-200 dark:border-green-800">
                <i class="ph ph-cpu text-green-500"></i>
                <span>AI Powered</span>
            </div>-->
            <div class="inline-flex items-center space-x-2 bg-green-50 dark:bg-green-950/30 text-green-600 dark:text-green-400 px-3 py-1.5 rounded-lg text-sm border border-green-200 dark:border-green-800">
                <i class="ph ph-flask text-green-500"></i>
                <span>Scientific Analysis</span>
            </div>
            <div class="inline-flex items-center space-x-2 bg-amber-50 dark:bg-amber-950/30 text-amber-600 dark:text-amber-400 px-3 py-1.5 rounded-lg text-sm border border-amber-200 dark:border-amber-800">
                <i class="ph ph-chart-bar text-amber-500"></i>
                <span>Visual Reports</span>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm">
        <!-- Chat Header -->
        <div class="border-b border-gray-200 dark:border-gray-700 p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center">
                        <i class="ph ph-camera text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-gray-900 dark:text-gray-100">Upload Your Meal Photo</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Drop an image or paste a URL to get started</p>
                    </div>
                </div>
                
                <!-- Diet Selection Dropdown (old UI restored, now dynamic) -->
                <div class="relative">
                    <button id="dietDropdownBtn" type="button" class="inline-flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 border border-gray-200 dark:border-gray-600">
                        <span id="selectedDietIcon">üçΩÔ∏è</span>
                        <span id="selectedDietText">Standard American</span>
                        <i class="ph ph-caret-down"></i>
                    </button>
                    
                    <div id="dietDropdown" class="hidden absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                        <div id="dietDropdownList" class="py-1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="p-4 min-h-[300px] max-h-[500px] overflow-y-auto space-y-4 bg-gray-50 dark:bg-gray-950">
            <!-- Welcome Message -->
            <div class="flex items-start space-x-3 chat-message">
                <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="ph ph-robot text-white text-sm"></i>
                </div>
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg rounded-tl-none p-3 max-w-md shadow-sm">
                    <p class="text-sm text-gray-700 dark:text-gray-300">Hi! I'm your AI nutrition analyst. Upload a photo of your meal or paste an image URL, and I'll provide detailed nutritional analysis based on your chosen diet goal.</p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="border-t border-gray-200 dark:border-gray-700 p-4 bg-white dark:bg-gray-900">
            <form id="analysisForm" enctype="multipart/form-data" class="space-y-4">
                <!-- Image Upload Tabs -->
                <div class="flex rounded-lg bg-gray-100 dark:bg-gray-800 p-1">
                    <button type="button" id="uploadTab" class="flex-1 flex items-center justify-center space-x-2 py-2 px-3 rounded-md bg-white dark:bg-gray-700 shadow-sm text-sm font-medium transition-all duration-200 text-gray-900 dark:text-gray-100 border border-gray-200 dark:border-gray-600">
                        <i class="ph ph-upload-simple text-green-500"></i>
                        <span>Upload File</span>
                    </button>
                    <button type="button" id="urlTab" class="flex-1 flex items-center justify-center space-x-2 py-2 px-3 rounded-md text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-200 transition-all duration-200">
                        <i class="ph ph-link"></i>
                        <span>Image URL</span>
                    </button>
                </div>

                <!-- Upload Content -->
                <div id="uploadContent">
                    <!-- File Upload -->
                    <div id="fileUpload" class="space-y-4">
                        <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center transition-colors duration-200 hover:border-green-400 hover:bg-green-50/50 dark:hover:bg-green-950/20 cursor-pointer bg-white dark:bg-gray-800">
                            <div class="w-12 h-12 mx-auto mb-4 text-gray-400 dark:text-gray-500">
                                <i class="ph ph-cloud-arrow-up text-4xl"></i>
                            </div>
                            <h4 class="text-lg font-medium mb-2 text-gray-900 dark:text-gray-100">Drag & Drop Your Photo Here</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Or click the button below to browse files</p>
                            <div class="flex justify-center space-x-2 mb-4">
                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded border border-gray-200 dark:border-gray-600">JPG</span>
                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded border border-gray-200 dark:border-gray-600">PNG</span>
                                <span class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-xs px-2 py-1 rounded border border-gray-200 dark:border-gray-600">WebP</span>
                            </div>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Maximum file size: 16MB</p>
                            <input type="file" id="imageFile" name="image_file" accept="image/*" class="hidden">
                            <button type="button" class="mt-4 inline-flex items-center space-x-2 bg-green-700 hover:bg-green-800 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 shadow-sm" onclick="document.getElementById('imageFile').click()">
                                <i class="ph ph-folder-open"></i>
                                <span>Choose Photo</span>
                            </button>
                        </div>
                    </div>

                    <!-- URL Input -->
                    <div id="urlInput" class="hidden">
                        <div class="flex space-x-2">
                            <div class="flex-1 relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="ph ph-link text-gray-400 dark:text-gray-500"></i>
                                </div>
                                <input type="url" name="image_url" placeholder="https://example.com/your-meal-photo.jpg" 
                                       class="w-full pl-10 pr-4 py-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 text-sm text-gray-900 dark:text-gray-100">
                            </div>
                            <button type="button" id="pasteUrl" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors duration-200 text-sm font-medium border border-gray-300 dark:border-gray-600">
                                Paste URL
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 flex items-center space-x-1">
                            <i class="ph ph-info"></i>
                            <span>Enter the direct URL to your meal image</span>
                        </p>
                    </div>
                </div>

                <!-- Personal Preferences -->
                <div class="space-y-3">
                    <!-- Meal Context -->
                    <div class="flex items-center space-x-2">
                        <i class="ph ph-bowl-food text-green-500"></i>
                        <h4 class="font-medium text-gray-900 dark:text-gray-100">Meal Context</h4>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(Optional)</span>
                    </div>
                    <div class="relative">
                        <button id="mealContextBtn" type="button" class="inline-flex items-center space-x-2 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200 border border-gray-200 dark:border-gray-600">
                            <span id="mealContextText">Meal Context</span>
                            <i class="ph ph-caret-down"></i>
                        </button>
                        <div id="mealContextDropdown" class="hidden absolute left-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50">
                            <div class="py-1">
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="">None</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="pre_workout">Pre-workout</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="post_workout">Post-workout</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="breakfast">Breakfast</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="lunch">Lunch</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="dinner">Dinner</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="study_snack">Study snack</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="social_meal">Social meal</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="stress_eating">Stress eating</button>
                                <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700" data-context="late_night_snack">Late-night snack</button>
                            </div>
                        </div>
                        <input type="hidden" id="mealContext" name="meal_context" value="">
                    </div>
                    <div class="flex items-center space-x-2">
                        <i class="ph ph-user-gear text-green-500"></i>
                        <h4 class="font-medium text-gray-900 dark:text-gray-100">Personal Preferences</h4>
                        <span class="text-xs text-gray-500 dark:text-gray-400">(Optional)</span>
                    </div>
                    <textarea name="user_preferences" rows="3" 
                              placeholder="Tell us about your preferences...

Examples:
‚Ä¢ I prefer spicy foods and want to increase protein
‚Ä¢ I have gluten sensitivity"
                              class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all duration-200 text-sm resize-none text-gray-900 dark:text-gray-100"></textarea>
                    <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center space-x-1">
                        <i class="ph ph-lightbulb"></i>
                        <span>The more details you provide, the better our recommendations!</span>
                    </p>
                </div>

                <!-- Usage Badge -->
                <div id="usageBadge" class="hidden mb-3 p-3 rounded-lg text-sm">
                    <!-- Content will be populated by JavaScript -->
                </div>

                <!-- Submit Button -->
                <button type="submit" id="analyzeBtn" class="w-full bg-gradient-to-r from-green-700 to-emerald-700 hover:from-green-800 hover:to-emerald-800 text-white py-3 px-4 rounded-lg font-medium transition-all duration-200 flex items-center justify-center space-x-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <i class="ph ph-magic-wand"></i>
                    <span>Analyze My Meal with AI</span>
                </button>

                <!-- Loading State -->
                <div id="loadingState" class="hidden text-center py-4">
                    <div class="inline-flex items-center space-x-3 bg-green-50 dark:bg-green-950/30 text-green-600 dark:text-green-400 px-4 py-2 rounded-lg border border-green-200 dark:border-green-800">
                        <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <span class="text-sm font-medium">AI is analyzing your meal<span class="loading-dots"></span></span>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">This may take 10-15 seconds</p>
                </div>

                <input type="hidden" id="dietGoal" name="diet_goal" value="standard_american">
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="hidden mt-8">
        <div id="analysisResult" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
            <!-- Results will be populated here -->
        </div>
    </div>

    <!-- Pro Tips -->
    <div class="mt-12 bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-950/20 dark:to-purple-950/20 rounded-xl p-6 border border-blue-200 dark:border-blue-800/30">
        <div class="flex items-center space-x-2 mb-4">
            <i class="ph ph-lightbulb text-yellow-500"></i>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100">Pro Tips for Better Results</h3>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center border border-blue-200 dark:border-blue-800">
                    <i class="ph ph-camera text-blue-600 dark:text-blue-400"></i>
                </div>
                <h4 class="font-medium mb-2 text-gray-900 dark:text-gray-100">Good Lighting</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Take photos in natural light when possible</p>
            </div>
            
            <div class="text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center border border-green-200 dark:border-green-800">
                    <i class="ph ph-arrows-out text-green-600 dark:text-green-400"></i>
                </div>
                <h4 class="font-medium mb-2 text-gray-900 dark:text-gray-100">Full View</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Show the complete meal from above</p>
            </div>
            
            <div class="text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center border border-purple-200 dark:border-purple-800">
                    <i class="ph ph-fork-knife text-purple-600 dark:text-purple-400"></i>
                </div>
                <h4 class="font-medium mb-2 text-gray-900 dark:text-gray-100">Include Utensils</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Helps AI estimate portion sizes</p>
            </div>
            
            <div class="text-center">
                <div class="w-12 h-12 mx-auto mb-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg flex items-center justify-center border border-orange-200 dark:border-orange-800">
                    <i class="ph ph-eye text-orange-600 dark:text-orange-400"></i>
                </div>
                <h4 class="font-medium mb-2 text-gray-900 dark:text-gray-100">Clear Details</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Make sure all ingredients are visible</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Markdown renderer (loaded lazily if not present)
if (typeof marked === 'undefined') {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
    document.head.appendChild(s);
}
document.addEventListener('DOMContentLoaded', function() {
    // Diet dropdown UI (old style)
    const dietGoalInput = document.getElementById('dietGoal');
    const dietDropdownBtn = document.getElementById('dietDropdownBtn');
    const dietDropdown = document.getElementById('dietDropdown');
    const dietDropdownList = document.getElementById('dietDropdownList');
    const selectedDietIcon = document.getElementById('selectedDietIcon');
    const selectedDietText = document.getElementById('selectedDietText');
    let dietsData = [];

    async function loadDiets() {
        try {
            const res = await fetch('/profile/api/diets');
            const data = await res.json();
            if (data.success) {
                dietsData = data.diets;
                buildDietDropdown(dietsData);
            }
        } catch {}
    }

    function emojiFor(slug) {
        const map = {
            'standard_american': 'üçΩÔ∏è',
            'mediterranean': 'ü´í',
            'ketogenic': 'ü•ë',
            'paleo': 'ü•©',
            'plant_based_vegan': 'üå±',
            'vegetarian': 'ü•ö',
            'pescatarian': 'üêü',
            'dash_diet': 'üßÇ',
            'intermittent_fasting_16_8': '‚è∞',
            'low_fodmap': 'üß¨',
            'low_carb': '‚öñÔ∏è',
            'flexitarian': 'ü•ó',
            'gluten_free': 'üö´üåæ',
            'whole30': 'üß≠',
            'anti_inflammatory': 'ü´ê'
        };
        return map[slug] || 'üçΩÔ∏è';
    }

    function buildDietDropdown(diets) {
        if (!dietDropdownList) return;
        const current = dietGoalInput.value || 'standard_american';
        dietDropdownList.innerHTML = diets.map(d => `
            <button data-slug="${d.slug}" class="w-full flex items-start space-x-3 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <span>${emojiFor(d.slug)}</span>
                <div class="text-left">
                    <div class="font-medium">${d.label}</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 line-clamp-1">${d.focus || ''}</div>
                </div>
            </button>
        `).join('');

        // Set current selection label
        const currentDiet = diets.find(x => x.slug === current) || diets[0];
        if (currentDiet) {
            selectedDietIcon.textContent = emojiFor(currentDiet.slug);
            selectedDietText.textContent = currentDiet.label;
        }

        dietDropdownList.querySelectorAll('button[data-slug]').forEach(btn => {
            btn.addEventListener('click', () => {
                const slug = btn.getAttribute('data-slug');
                dietGoalInput.value = slug;
                const diet = diets.find(x => x.slug === slug);
                if (diet) {
                    selectedDietIcon.textContent = emojiFor(slug);
                    selectedDietText.textContent = diet.label;
                }
                dietDropdown.classList.add('hidden');
                addChatMessage('user', `I've selected the ${diet.label}.`);
                addChatMessage('assistant', 'Great choice! Now upload your meal photo for analysis.');
            });
        });
    }

    // Toggle dropdown
    if (dietDropdownBtn) {
        dietDropdownBtn.addEventListener('click', () => {
            dietDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!dietDropdownBtn.contains(e.target) && !dietDropdown.contains(e.target)) {
                dietDropdown.classList.add('hidden');
            }
        });
    }

    // Tab switching
    const uploadTabBtn = document.getElementById('uploadTab');
    const urlTabBtn = document.getElementById('urlTab');
    const fileUpload = document.getElementById('fileUpload');
    const urlInput = document.getElementById('urlInput');

    uploadTabBtn.addEventListener('click', () => {
        uploadTabBtn.classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'border', 'border-gray-200', 'dark:border-gray-600', 'text-gray-900', 'dark:text-gray-100');
        urlTabBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'border', 'border-gray-200', 'dark:border-gray-600', 'text-gray-900', 'dark:text-gray-100');
        urlTabBtn.classList.add('text-gray-600', 'dark:text-gray-400');
        fileUpload.classList.remove('hidden');
        urlInput.classList.add('hidden');
    });

    urlTabBtn.addEventListener('click', () => {
        urlTabBtn.classList.add('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'border', 'border-gray-200', 'dark:border-gray-600', 'text-gray-900', 'dark:text-gray-100');
        uploadTabBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'shadow-sm', 'border', 'border-gray-200', 'dark:border-gray-600', 'text-gray-900', 'dark:text-gray-100');
        uploadTabBtn.classList.add('text-gray-600', 'dark:text-gray-400');
        urlInput.classList.remove('hidden');
        fileUpload.classList.add('hidden');
    });

    // Drag and drop functionality
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('imageFile');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-400', 'bg-blue-50/50', 'dark:bg-blue-950/20');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50/50', 'dark:bg-blue-950/20');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-400', 'bg-blue-50/50', 'dark:bg-blue-950/20');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelection(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelection(e.target.files[0]);
        }
    });

    // File selection handler
    function handleFileSelection(file) {
        if (file && file.type.startsWith('image/')) {
            addChatMessage('user', `Uploaded: ${file.name}`);
            
            // Show image preview in chat
            const reader = new FileReader();
            reader.onload = function(e) {
                addImagePreview(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
            
            addChatMessage('assistant', 'Perfect! I can see your meal photo. Click "Analyze My Meal with AI" to get your nutrition analysis.');
        }
    }

    // Paste URL functionality
    document.getElementById('pasteUrl').addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            if (text && (text.startsWith('http') || text.startsWith('https'))) {
                document.querySelector('input[name="image_url"]').value = text;
                addChatMessage('user', `Pasted image URL: ${text}`);
                addChatMessage('assistant', 'Great! I can see the image URL. Click "Analyze My Meal with AI" to get your nutrition analysis.');
            }
        } catch (err) {
            console.log('Failed to read clipboard');
        }
    });

    // Form submission function
    function analyzeForm() {
        const form = document.getElementById('analysisForm');
        const formData = new FormData(form);
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingState = document.getElementById('loadingState');
        
        // Show loading state
        analyzeBtn.classList.add('hidden');
        loadingState.classList.remove('hidden');
        
        addChatMessage('assistant', 'Analyzing your meal with AI...');
        
        // Choose endpoint: if user is signed in and has profile, use profile-aware API; else fallback
        // We optimistically call profile-aware endpoint; backend will still work for guests
        fetch('/api/analyze-with-profile', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 429) {
                // Handle rate limit specifically
                return response.json().then(data => {
                    throw new Error(data.message || 'Daily limit exceeded');
                });
            }
            return response.json();
        })
        .then(data => {
            analyzeBtn.classList.remove('hidden');
            loadingState.classList.add('hidden');
            
            if (data.error) {
                if (data.error === 'limit_exceeded') {
                    showNotification('error', data.message);
                    addChatMessage('assistant', `${data.message}`);
                    // Refresh usage status
                    loadUsageStatus();
                } else {
                    addChatMessage('assistant', `Sorry, there was an error: ${data.error}`);
                    showNotification('error', 'Analysis failed: ' + data.error);
                }
            } else {
                displayResults(data);
                // Only save to history if user is signed in (server handles this)
                // No local storage saving for guests
                // Refresh usage status
                loadUsageStatus();
            }
        })
        .catch(error => {
            analyzeBtn.classList.remove('hidden');
            loadingState.classList.add('hidden');
            addChatMessage('assistant', 'Sorry, there was an error processing your request. Please try again.');
            showNotification('error', error.message || 'Network error: Please check your connection and try again.');
        });
    }

    // Form submission event
    document.getElementById('analysisForm').addEventListener('submit', function(e) {
        e.preventDefault();
        analyzeForm();
    });

    // Chat message functions
    function addChatMessage(sender, message) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3 chat-message';
        
        if (sender === 'user') {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gray-600 dark:bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="ph ph-user text-white dark:text-gray-900 text-sm"></i>
                </div>
                <div class="bg-blue-600 text-white rounded-lg rounded-tl-none p-3 max-w-md shadow-sm">
                    <p class="text-sm">${message}</p>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="ph ph-robot text-white text-sm"></i>
                </div>
                <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg rounded-tl-none p-3 max-w-md shadow-sm">
                    <p class="text-sm text-gray-700 dark:text-gray-300">${message}</p>
                </div>
            `;
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function addImagePreview(src, filename) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'flex items-start space-x-3 chat-message';
        
        messageDiv.innerHTML = `
            <div class="w-8 h-8 bg-gray-600 dark:bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="ph ph-user text-white dark:text-gray-900 text-sm"></i>
            </div>
            <div class="bg-blue-600 text-white rounded-lg rounded-tl-none p-3 max-w-md shadow-sm">
                <img src="${src}" alt="${filename}" class="w-full h-32 object-cover rounded-lg mb-2">
                <p class="text-sm">${filename}</p>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function displayResults(data) {
        addChatMessage('assistant', 'Analysis complete! Your detailed results are shown below:');
        const resultsSection = document.getElementById('resultsSection');
        const analysisResult = document.getElementById('analysisResult');

        // Prefer markdown coming from backend
        let cleanAnalysis = data.analysis || 'Analysis not available';
        // Strip any visible fenced code blocks (DATA_PAYLOAD or others)
        cleanAnalysis = cleanAnalysis.replace(/```[\s\S]*?```/g, '').trim();
        // Promote common all-caps headings if present
        const headingCaps = [
            'MEAL IDENTIFICATION','NUTRITIONAL ESTIMATION','DIET COMPATIBILITY SCORE',
            'POSITIVE ASPECTS','AREAS FOR IMPROVEMENT','PERSONALIZED RECOMMENDATIONS',
            'OVERALL HEALTH SCORE','PERSONALIZED ADVICE','SUMMARY','MEAL BREAKDOWN','MACROS & KEY NUTRIENTS'
        ];
        headingCaps.forEach(h => {
            const re = new RegExp('(^|\\n)'+h+':', 'g');
            cleanAnalysis = cleanAnalysis.replace(re, `\n\n### ${h.replace(/_/g,' ')}\n`);
        });

        // Render markdown (fallback to light HTML)
        function renderAsHTML(text) {
            if (/‚Ä¢/.test(text)) text = text.replace(/\s*‚Ä¢\s*/g, '\n- ');
            text = text.replace(/^‚Ä¢\s+/gm, '- ');
            const paragraphs = text.split(/\n\n+/).map(p => p.trim());
            let html = '';
            const hRe = /^###\s+(.*)$/i;
            paragraphs.forEach(p => {
                if (!p) return;
                if (hRe.test(p)) {
                    const m = p.match(hRe);
                    html += `<h3 class="text-xl font-semibold mb-3 text-gray-900 dark:text-gray-100">${m[1]}</h3>`;
                } else if (/^\-\s+/.test(p) || /\n\-\s+/.test('\n'+p)) {
                    const items = p.split(/\n/).filter(x=>/^\-\s+/.test(x)).map(x=>x.replace(/^\-\s+/,''));
                    html += `<ul class="list-disc pl-6 space-y-1 text-gray-700 dark:text-gray-300">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
                } else {
                    const colonBold = p.replace(/(^|\n)([A-Za-z][A-Za-z\s]+:)\s/g, (m,g1,g2)=>`${g1}<strong class=\"text-gray-900 dark:text-gray-100\">${g2}</strong> `);
                    html += `<p class="mb-3 leading-relaxed text-gray-700 dark:text-gray-300">${colonBold}</p>`;
                }
            });
            return html;
        }
        let renderedMarkdown = '';
        try {
            if (typeof marked !== 'undefined') {
                renderedMarkdown = marked.parse(cleanAnalysis);
            } else {
                renderedMarkdown = renderAsHTML(cleanAnalysis);
            }
        } catch(e) { renderedMarkdown = renderAsHTML(cleanAnalysis) }

        // Enhance tables globally: add borders/striping via wrapper CSS classes
        const prose = `
            <style>
              #analysisResult table { border-collapse: separate; border-spacing: 0; width: 100%; }
              #analysisResult thead th { border-bottom: 1px solid var(--tw-prose-borders, #e5e7eb); }
              #analysisResult td, #analysisResult th { border-right: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; }
              #analysisResult tr > *:last-child { border-right: 0 }
              #analysisResult tbody tr { border-bottom: 1px solid #e5e7eb }
              .dark #analysisResult thead th, .dark #analysisResult tbody tr { border-color: #374151 }
              .dark #analysisResult td, .dark #analysisResult th { border-color: #374151 }
            </style>`;

        analysisResult.innerHTML = `${prose}
            <div class="prose prose-sm max-w-none dark:prose-invert">
                <div class="text-gray-700 dark:text-gray-300 leading-relaxed space-y-3">${renderedMarkdown}</div>
            </div>`;

        resultsSection.classList.remove('hidden');
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }

    // History is now handled server-side only for signed-in users
    // Guests get temporary analysis results without persistent storage

    // Notification system (same as history page)
    function showNotification(message, type = 'info') {
        // Remove any existing notifications
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg border max-w-sm transition-all duration-300 transform translate-x-full opacity-0';
        
        // Set colors based on type
        if (type === 'success') {
            notification.classList.add('bg-green-50', 'dark:bg-green-950/30', 'border-green-200', 'dark:border-green-800', 'text-green-800', 'dark:text-green-200');
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="ph ph-check-circle text-green-500 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
        } else if (type === 'error') {
            notification.classList.add('bg-red-50', 'dark:bg-red-950/30', 'border-red-200', 'dark:border-red-800', 'text-red-800', 'dark:text-red-200');
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="ph ph-warning text-red-500 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
        } else {
            notification.classList.add('bg-blue-50', 'dark:bg-blue-950/30', 'border-blue-200', 'dark:border-blue-800', 'text-blue-800', 'dark:text-blue-200');
            notification.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="ph ph-info text-blue-500 text-xl"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;
        }
        
        // Add to page
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.classList.remove('translate-x-full', 'opacity-0');
            notification.classList.add('translate-x-0', 'opacity-100');
        }, 100);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }, 3000);
    }

    // Usage tracking and limits
    async function loadUsageStatus() {
        try {
            const response = await fetch('/api/usage');
            const data = await response.json();
            updateUsageBadge(data);
        } catch (error) {
            console.error('Failed to load usage status:', error);
        }
    }

    function updateUsageBadge(data) {
        const badge = document.getElementById('usageBadge');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        if (!data.usage.analyses) return;
        
        const { current, limit, near_limit, at_limit } = data.usage.analyses;
        
        // Show badge for guests or when near/at limit
        if (data.user_type === 'guest' || near_limit || at_limit) {
            badge.classList.remove('hidden');
            
            if (at_limit) {
                badge.className = 'mb-3 p-3 rounded-lg text-sm bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-200';
                badge.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="ph ph-warning text-red-500"></i>
                        <span>Daily limit reached (${current}/${limit}). ${data.user_type === 'guest' ? 'Sign in for higher limits.' : 'Try again tomorrow.'}</span>
                    </div>
                `;
                // Disable button
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else if (near_limit) {
                badge.className = 'mb-3 p-3 rounded-lg text-sm bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 text-amber-800 dark:text-amber-200';
                badge.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="ph ph-warning text-amber-500"></i>
                        <span>${current}/${limit} analyses used today</span>
                    </div>
                `;
            } else if (data.user_type === 'guest') {
                badge.className = 'mb-3 p-3 rounded-lg text-sm bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-200';
                badge.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="ph ph-info text-blue-500"></i>
                        <span>Guest mode (${current}/${limit} analyses today) ‚Äî <a href="#" onclick="document.getElementById('openLoginModal').click()" class="underline hover:no-underline">sign in</a> to sync and unlock more</span>
                    </div>
                `;
            }
        } else {
            badge.classList.add('hidden');
        }
    }



    // Load usage status and diet list on page load
    loadUsageStatus();
    loadDiets();

    // Set default from user's saved diet preference
    (async function setDefaultDietFromProfile(){
        try {
            const res = await fetch('/profile/api/load');
            const data = await res.json();
            if (data.success && data.data && data.data.preferences && data.data.preferences.diet_type) {
                const savedSlug = data.data.preferences.diet_type;
                dietGoalInput.value = savedSlug;
                // Update button label when diets are already loaded
                const diet = (dietsData || []).find(x => x.slug === savedSlug);
                if (diet) {
                    selectedDietIcon.textContent = emojiFor(savedSlug);
                    selectedDietText.textContent = diet.label;
                }
            }
        } catch(_){}
    })();

    // Meal context dropdown logic
    const mealContextBtn = document.getElementById('mealContextBtn');
    const mealContextDropdown = document.getElementById('mealContextDropdown');
    const mealContextHidden = document.getElementById('mealContext');
    const mealContextText = document.getElementById('mealContextText');
    if (mealContextBtn) {
        mealContextBtn.addEventListener('click', () => {
            mealContextDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!mealContextBtn.contains(e.target) && !mealContextDropdown.contains(e.target)) {
                mealContextDropdown.classList.add('hidden');
            }
        });
        mealContextDropdown.querySelectorAll('button[data-context]').forEach(b => {
            b.addEventListener('click', () => {
                const val = b.getAttribute('data-context');
                mealContextHidden.value = val;
                mealContextText.textContent = val ? b.textContent : 'Meal Context';
                mealContextDropdown.classList.add('hidden');
            });
        });
    }

    // Initialize with welcome message
    addChatMessage('assistant', 'Welcome! I\'m your AI nutrition analyst. Please select your diet goal from the dropdown above, then upload a meal photo or paste an image URL to get started.');
});
</script>
{% endblock %}