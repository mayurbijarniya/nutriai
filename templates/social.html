{% extends "base.html" %}

{% block title %}Social Challenges - NutriAI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 space-y-5 sm:space-y-7">
    <section class="glass-panel rounded-3xl p-4 sm:p-6 border border-white/40 dark:border-white/10 overflow-hidden relative">
        <div class="absolute -top-20 -right-12 w-52 h-52 bg-emerald-300/25 dark:bg-emerald-500/20 blur-3xl rounded-full pointer-events-none"></div>
        <div class="absolute -bottom-20 -left-10 w-44 h-44 bg-cyan-300/20 dark:bg-cyan-500/15 blur-3xl rounded-full pointer-events-none"></div>
        <div class="relative grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white font-serif-accent">Social Challenges</h1>
                <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300 mt-1">Create accountability loops with friends, join active challenges, and climb consistency leaderboards.</p>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:gap-3">
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="statActiveChallenges" class="text-lg sm:text-xl font-bold">0</p>
                    <p class="text-[11px] text-gray-500">Active</p>
                </div>
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="statJoinedChallenges" class="text-lg sm:text-xl font-bold">0</p>
                    <p class="text-[11px] text-gray-500">Joined</p>
                </div>
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="statMyChallenges" class="text-lg sm:text-xl font-bold">0</p>
                    <p class="text-[11px] text-gray-500">Created</p>
                </div>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 sm:gap-6">
        <aside class="xl:col-span-1 space-y-3 xl:sticky xl:top-28 self-start">
            <div class="glass-panel rounded-2xl p-4 sm:p-5 border border-white/30 dark:border-white/10">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-base sm:text-lg font-bold">Create Challenge</h2>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Name</label>
                        <input id="challengeName" class="input-glass w-full rounded-xl px-3 py-2.5 text-sm" placeholder="e.g. 14-Day Consistency Sprint" maxlength="80" />
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Description</label>
                        <textarea id="challengeDescription" rows="3" class="input-glass w-full rounded-xl px-3 py-2.5 text-sm" placeholder="What are we committing to this week?" maxlength="220"></textarea>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-500 mb-1">Goal</label>
                        <div class="relative">
                            <i class="ph ph-target absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            <select id="challengeGoal" class="selector-pill w-full pl-9 pr-10 py-2.5 text-sm appearance-none">
                                <option value="meal_logging_streak">Meal logging</option>
                                <option value="hydration_consistency">Hydration</option>
                                <option value="nutrition_consistency">Nutrition consistency</option>
                            </select>
                            <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                        </div>
                    </div>

                    <div>
                        <div class="flex items-center justify-between mb-1">
                            <label class="block text-xs font-semibold text-gray-500">Duration</label>
                            <span id="challengeDurationLabel" class="text-xs font-semibold text-gray-600 dark:text-gray-300">14 days</span>
                        </div>
                        <input id="challengeDuration" type="range" min="3" max="90" value="14" class="w-full accent-emerald-500" />
                    </div>

                    <button id="createChallenge" class="btn-primary w-full py-2.5 rounded-xl text-sm font-semibold inline-flex items-center justify-center gap-2">
                        <i class="ph ph-plus"></i>
                        <span>Create Challenge</span>
                    </button>

                    <p id="challengeStatus" class="text-xs hidden"></p>
                </div>
            </div>
        </aside>

        <section class="xl:col-span-2 glass-panel rounded-2xl p-4 sm:p-5 border border-white/30 dark:border-white/10">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
                <h2 class="text-base sm:text-lg font-bold">Active Challenges</h2>
                <div class="control-strip w-full md:w-auto flex-wrap">
                    <div class="relative flex-1 min-w-[12rem]">
                        <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input id="challengeSearch" class="selector-pill rounded-xl pl-9 pr-3 py-2 text-sm w-full" placeholder="Search challenge" />
                    </div>
                    <div class="relative min-w-[11rem]">
                        <i class="ph ph-funnel absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                        <select id="challengeGoalFilter" class="selector-pill w-full pl-9 pr-10 py-2 text-sm appearance-none">
                            <option value="all">All goals</option>
                            <option value="meal_logging_streak">Meal logging</option>
                            <option value="hydration_consistency">Hydration</option>
                            <option value="nutrition_consistency">Nutrition consistency</option>
                        </select>
                        <i class="ph ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none"></i>
                    </div>
                    <button id="refreshChallenges" class="btn-secondary px-3 py-2 rounded-xl text-sm inline-flex items-center justify-center gap-1.5 min-w-[6.75rem]">
                        <i class="ph ph-arrows-clockwise"></i>
                        <span>Refresh</span>
                    </button>
                </div>
            </div>

            <div id="challengeList" class="space-y-3"></div>
        </section>
    </div>

    <section class="glass-panel rounded-2xl p-4 sm:p-6 border border-white/30 dark:border-white/10">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
            <div>
                <h2 class="text-base sm:text-lg font-bold">Leaderboard</h2>
                <p id="leaderboardLabel" class="text-sm text-gray-500">Pick a challenge to see rankings</p>
            </div>
            <span id="leaderboardGoal" class="chip-toggle text-xs hidden"></span>
        </div>
        <div id="leaderboardList" class="space-y-2"></div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentChallengeId = null;
    let challengesCache = [];

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatDate(dateLike) {
        if (!dateLike) return 'n/a';
        const d = new Date(dateLike);
        if (Number.isNaN(d.getTime())) return 'n/a';
        return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function setChallengeStatus(msg, ok = true) {
        const el = document.getElementById('challengeStatus');
        if (!msg) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
        }
        el.textContent = msg;
        el.className = `text-xs ${ok ? 'text-emerald-600 dark:text-emerald-300' : 'text-red-600 dark:text-red-400'}`;
    }

    function updateDurationLabel() {
        const v = Number(document.getElementById('challengeDuration').value || 14);
        document.getElementById('challengeDurationLabel').textContent = `${v} day${v === 1 ? '' : 's'}`;
    }

    function renderStats(challenges) {
        const joined = challenges.filter(c => c.joined).length;
        const mine = challenges.filter(c => c.is_created_by_you).length;
        document.getElementById('statActiveChallenges').textContent = challenges.length;
        document.getElementById('statJoinedChallenges').textContent = joined;
        document.getElementById('statMyChallenges').textContent = mine;
    }

    function renderChallengeList() {
        const list = document.getElementById('challengeList');
        const q = (document.getElementById('challengeSearch').value || '').trim().toLowerCase();
        const goalFilter = document.getElementById('challengeGoalFilter').value;

        const items = challengesCache.filter((c) => {
            const matchesGoal = goalFilter === 'all' || c.goal === goalFilter;
            const hay = `${c.name || ''} ${c.description || ''} ${c.created_by_name || ''}`.toLowerCase();
            const matchesQuery = !q || hay.includes(q);
            return matchesGoal && matchesQuery;
        });

        if (!items.length) {
            list.innerHTML = '<div class="surface-solid rounded-2xl p-5 text-sm text-gray-500">No challenges match your filters.</div>';
            return;
        }

        list.innerHTML = items.map((c) => {
            const selected = currentChallengeId === c._id;
            const yourProgress = c.joined ? `${c.your_score || 0}/${c.duration_days || 0} days` : 'Not joined';
            const progressPct = Number(c.your_progress_pct || 0);

            return `
                <article class="surface-solid rounded-2xl p-4 border ${selected ? 'border-emerald-400/70' : 'border-transparent'} transition-colors">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                        <div class="space-y-2">
                            <div class="flex flex-wrap items-center gap-2">
                                <h3 class="font-bold text-gray-900 dark:text-white">${escapeHtml(c.name || 'Challenge')}</h3>
                                <span class="chip-toggle text-[11px]">${escapeHtml(c.goal_label || 'Goal')}</span>
                                ${c.joined ? '<span class="chip-toggle chip-toggle-active text-[11px]">Joined</span>' : ''}
                                ${c.is_created_by_you ? '<span class="chip-toggle text-[11px]">Created by you</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">${escapeHtml(c.description || '')}</p>
                            <div class="flex flex-wrap gap-3 text-xs text-gray-500">
                                <span><i class="ph ph-users-three"></i> ${Number(c.participant_count || 0)} participants</span>
                                <span><i class="ph ph-calendar"></i> ${formatDate(c.start_at)} - ${formatDate(c.end_at)}</span>
                                <span><i class="ph ph-clock"></i> ${Number(c.duration_days || 0)} days</span>
                                <span><i class="ph ph-user"></i> ${escapeHtml(c.created_by_name || 'Community')}</span>
                            </div>
                            <div>
                                <div class="flex items-center justify-between text-[11px] text-gray-500 mb-1">
                                    <span>Your progress</span>
                                    <span>${escapeHtml(yourProgress)}</span>
                                </div>
                                <div class="h-1.5 rounded-full bg-gray-200 dark:bg-gray-800 overflow-hidden">
                                    <div class="h-full bg-emerald-500 transition-all" style="width:${Math.max(0, Math.min(100, progressPct))}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 sm:flex-col sm:w-36">
                            <button class="btn-secondary rounded-xl py-2 text-xs font-semibold challenge-action flex-1" data-action="leaderboard" data-id="${escapeHtml(c._id)}">View board</button>
                            ${c.joined
                                ? '<button class="btn-secondary rounded-xl py-2 text-xs font-semibold opacity-70 cursor-default flex-1" disabled>Joined</button>'
                                : `<button class="btn-primary rounded-xl py-2 text-xs font-semibold challenge-action flex-1" data-action="join" data-id="${escapeHtml(c._id)}">Join</button>`}
                        </div>
                    </div>
                </article>
            `;
        }).join('');
    }

    async function loadChallenges() {
        const res = await fetch('/api/v3/social/challenges');
        const data = await res.json();
        if (!data.success) {
            setChallengeStatus(data.error || 'Could not load challenges.', false);
            return;
        }
        challengesCache = data.challenges || [];
        renderStats(challengesCache);
        renderChallengeList();

        if (!currentChallengeId && challengesCache.length) {
            currentChallengeId = challengesCache[0]._id;
            await loadLeaderboard(currentChallengeId);
        } else if (currentChallengeId) {
            const stillExists = challengesCache.some(c => c._id === currentChallengeId);
            if (!stillExists && challengesCache.length) {
                currentChallengeId = challengesCache[0]._id;
            }
            if (currentChallengeId) {
                await loadLeaderboard(currentChallengeId);
            }
        }

        renderChallengeList();
    }

    async function createChallenge() {
        const createBtn = document.getElementById('createChallenge');
        const payload = {
            name: (document.getElementById('challengeName').value || '').trim(),
            description: (document.getElementById('challengeDescription').value || '').trim(),
            goal: document.getElementById('challengeGoal').value,
            duration_days: Number(document.getElementById('challengeDuration').value || 14),
        };

        if (!payload.name) {
            setChallengeStatus('Please enter a challenge name.', false);
            return;
        }

        createBtn.disabled = true;
        createBtn.classList.add('opacity-70', 'cursor-not-allowed');
        try {
            const res = await fetch('/api/v3/social/challenges', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!data.success) {
                setChallengeStatus(data.error || 'Could not create challenge.', false);
                return;
            }

            setChallengeStatus('Challenge created successfully.', true);
            document.getElementById('challengeName').value = '';
            document.getElementById('challengeDescription').value = '';
            currentChallengeId = data.challenge?._id || null;
            await loadChallenges();
        } catch (_) {
            setChallengeStatus('Network error while creating challenge.', false);
        } finally {
            createBtn.disabled = false;
            createBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    }

    async function joinChallenge(id) {
        const res = await fetch(`/api/v3/social/challenges/${id}/join`, { method: 'POST' });
        const data = await res.json();
        if (!data.success) {
            setChallengeStatus(data.error || 'Could not join challenge.', false);
            return;
        }
        currentChallengeId = id;
        await loadChallenges();
        await loadLeaderboard(id);
    }

    async function loadLeaderboard(id) {
        currentChallengeId = id;
        renderChallengeList();
        const challenge = challengesCache.find(c => c._id === id) || null;
        document.getElementById('leaderboardLabel').textContent = challenge ? `${challenge.name} - ${challenge.duration_days} day challenge` : 'Leaderboard';

        const goalChip = document.getElementById('leaderboardGoal');
        if (challenge && challenge.goal_label) {
            goalChip.textContent = challenge.goal_label;
            goalChip.classList.remove('hidden');
        } else {
            goalChip.classList.add('hidden');
            goalChip.textContent = '';
        }

        const res = await fetch(`/api/v3/social/challenges/${id}/leaderboard`);
        const data = await res.json();
        const list = document.getElementById('leaderboardList');
        if (!data.success) {
            list.innerHTML = '<div class="surface-solid rounded-2xl p-4 text-sm text-red-500">Could not load leaderboard.</div>';
            return;
        }

        const rows = data.leaderboard || [];
        if (!rows.length) {
            list.innerHTML = '<div class="surface-solid rounded-2xl p-4 text-sm text-gray-500">No members yet.</div>';
            return;
        }

        list.innerHTML = rows.map((row) => {
            const topThreeStyle = row.rank === 1
                ? 'bg-amber-50/80 border-amber-300/60 dark:bg-amber-900/20'
                : row.rank === 2
                    ? 'bg-slate-50/80 border-slate-300/60 dark:bg-slate-800/35'
                    : row.rank === 3
                        ? 'bg-orange-50/80 border-orange-300/60 dark:bg-orange-900/20'
                        : (row.is_you ? 'bg-emerald-50/70 border-emerald-300/60 dark:bg-emerald-900/20' : 'surface-solid border-transparent');

            const avatar = row.picture
                ? `<img src="${escapeHtml(row.picture)}" alt="${escapeHtml(row.name)}" class="w-9 h-9 rounded-full object-cover border border-white/70">`
                : `<div class="w-9 h-9 rounded-full bg-emerald-100 dark:bg-emerald-900/40 text-emerald-700 dark:text-emerald-300 flex items-center justify-center font-bold text-xs">${escapeHtml((row.name || 'U').slice(0, 1).toUpperCase())}</div>`;

            return `
                <div class="rounded-2xl border p-3 sm:p-3.5 flex items-center justify-between ${topThreeStyle}">
                    <div class="flex items-center gap-3 min-w-0">
                        <div class="w-7 text-center font-bold text-sm">${row.rank}</div>
                        ${avatar}
                        <div class="min-w-0">
                            <p class="font-semibold text-sm truncate">${escapeHtml(row.name)}${row.is_you ? ' <span class="text-emerald-600 dark:text-emerald-300">(You)</span>' : ''}</p>
                            <p class="text-xs text-gray-500">${escapeHtml(row.goal_label || 'Consistency')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-base leading-tight">${Number(row.score || 0)}</p>
                        <p class="text-xs text-gray-500">${escapeHtml(row.goal_unit || 'days')}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateDurationLabel();
        document.getElementById('challengeDuration').addEventListener('input', updateDurationLabel);
        document.getElementById('createChallenge').addEventListener('click', createChallenge);
        document.getElementById('refreshChallenges').addEventListener('click', loadChallenges);
        document.getElementById('challengeSearch').addEventListener('input', renderChallengeList);
        document.getElementById('challengeGoalFilter').addEventListener('change', renderChallengeList);

        document.getElementById('challengeList').addEventListener('click', async (event) => {
            const btn = event.target.closest('.challenge-action');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            if (!id || !action) return;

            if (action === 'join') {
                await joinChallenge(id);
            } else if (action === 'leaderboard') {
                await loadLeaderboard(id);
                renderChallengeList();
            }
        });

        loadChallenges();
    });
</script>
{% endblock %}
