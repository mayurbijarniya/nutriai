{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

  <!-- Header with Greeting -->
  <div class="flex items-center justify-between">
    <div>
      <h1 id="welcomeHeading" class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white font-serif-accent">
        Welcome back!</h1>
      <div class="flex items-center gap-2 mt-1">
        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        <p id="dayProgress" class="text-sm font-medium text-gray-500 dark:text-gray-400">Loading today's status...</p>
      </div>
    </div>
    <div>
      <!-- Settings or Profile shortcut could go here -->
    </div>
  </div>

  <!-- Top Metrics Row -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <!-- Daily Calories (Glass Card) -->
    <div class="glass-panel rounded-2xl p-1 relative overflow-hidden group">
      <div
        class="absolute inset-0 bg-gradient-to-br from-green-50/50 to-emerald-50/50 dark:from-green-900/10 dark:to-emerald-900/10 pointer-events-none">
      </div>
      <div class="bg-white/40 dark:bg-gray-900/40 rounded-xl p-5 relative z-10 h-full">
        <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-4">Daily Calories</h3>
        <div class="flex items-center justify-between">
          <div class="relative w-20 h-20">
            <svg viewBox="0 0 36 36" class="w-20 h-20 transform -rotate-90">
              <path class="text-gray-200 dark:text-gray-700" stroke="currentColor" stroke-width="3" fill="none"
                d="M18 2a16 16 0 1 1 0 32 16 16 0 0 1 0-32" />
              <path id="calProgressPath" class="text-green-500 drop-shadow-sm transition-all duration-1000 ease-out"
                stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"
                d="M18 2a16 16 0 1 1 0 32 16 16 0 0 1 0-32" stroke-dasharray="0,100" />
            </svg>
            <div class="absolute inset-0 flex items-center justify-center flex-col">
              <span id="caloriesRemain" class="text-sm font-bold text-gray-900 dark:text-white leading-none">â€”</span>
              <span class="text-[9px] text-gray-500 uppercase">Left</span>
            </div>
          </div>
          <div class="text-right">
            <div class="text-2xl font-bold font-serif-accent text-gray-900 dark:text-white"><span
                id="caloriesConsumed">â€”</span></div>
            <div class="text-xs text-gray-500 mb-2">of <span id="caloriesTarget">â€”</span> kcal</div>
            <button id="quickMeal"
              class="text-[10px] font-bold uppercase tracking-wider text-green-600 hover:text-green-700 bg-green-100/50 hover:bg-green-100 dark:bg-green-600 dark:text-white dark:hover:bg-green-500 px-3 py-1.5 rounded-full transition-colors">
              + Log Meal
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Macros (Glass Card) -->
    <div class="glass-panel rounded-2xl p-6 flex flex-col justify-center">
      <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-4">Macronutrients</h3>
      <div class="space-y-4">
        <!-- Protein -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="font-medium text-blue-600 dark:text-blue-400">Protein</span>
            <span class="text-gray-600 dark:text-gray-400"><span id="proG">0</span> / <span id="proT">0</span>g</span>
          </div>
          <div class="w-full h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
            <div id="proBar" class="h-full bg-blue-500 rounded-full transition-all duration-700" style="width:0%"></div>
          </div>
        </div>
        <!-- Carbs -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="font-medium text-emerald-600 dark:text-emerald-400">Carbs</span>
            <span class="text-gray-600 dark:text-gray-400"><span id="carbG">0</span> / <span id="carbT">0</span>g</span>
          </div>
          <div class="w-full h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
            <div id="carbBar" class="h-full bg-emerald-500 rounded-full transition-all duration-700" style="width:0%">
            </div>
          </div>
        </div>
        <!-- Fat -->
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="font-medium text-amber-600 dark:text-amber-400">Fat</span>
            <span class="text-gray-600 dark:text-gray-400"><span id="fatG">0</span> / <span id="fatT">0</span>g</span>
          </div>
          <div class="w-full h-1.5 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
            <div id="fatBar" class="h-full bg-amber-500 rounded-full transition-all duration-700" style="width:0%">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Diet Score (Glass Card) -->
    <div class="glass-panel rounded-2xl p-6 text-center flex flex-col items-center justify-center relative">
      <div
        class="absolute inset-0 bg-gradient-to-t from-green-50/30 to-transparent dark:from-green-900/10 pointer-events-none">
      </div>
      <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 mb-2 relative z-10">
        Adherence Score</h3>

      <div class="relative z-10">
        <span
          class="text-5xl font-bold font-serif-accent bg-gradient-to-r from-green-500 to-emerald-600 bg-clip-text text-transparent"
          id="dietScore">â€”</span>
        <span class="text-xl text-gray-400 font-light">/10</span>
      </div>

      <div id="dietBadge"
        class="mt-2 text-xs font-medium px-2 py-1 rounded bg-green-100/50 dark:bg-green-900/30 text-green-700 dark:text-green-300 relative z-10">
        Flexible Dieting
      </div>
    </div>

    <!-- Hydration (Glass Card) -->
    <div class="glass-panel rounded-2xl p-6 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400">Hydration</h3>
        <span class="text-xs font-medium text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded-full"><span
            id="hydrationMl">0</span> ml</span>
      </div>

      <div class="flex-1 flex items-center justify-between gap-1 mb-4" id="hydrationDrops">
        <!-- Populated by JS -->
      </div>

      <button id="logWater"
        class="w-full btn-primary py-2 rounded-lg text-xs font-bold uppercase tracking-wide flex items-center justify-center gap-2">
        <i class="ph ph-drop-fill text-blue-400"></i>
        <span>Add Water (250ml)</span>
      </button>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- Timeline (Left 2/3) -->
    <div class="lg:col-span-2 space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-bold text-gray-900 dark:text-white font-serif-accent">Today's Meals</h2>
        <a href="/history" class="text-sm font-medium text-green-600 hover:text-green-700 flex items-center gap-1">
          View History <i class="ph ph-arrow-right"></i>
        </a>
      </div>

      <div id="mealsList" class="space-y-4">
        <!-- Populated by JS -->
        <div class="glass-panel p-8 text-center rounded-2xl">
          <p class="text-gray-500">Loading your meals...</p>
        </div>
      </div>
    </div>

    <!-- Insights (Right 1/3) -->
    <div class="lg:col-span-1">
      <h2 class="text-xl font-bold text-gray-900 dark:text-white font-serif-accent mb-6">AI Insights</h2>
      <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-yellow-200/20 dark:bg-yellow-500/10 rounded-full blur-2xl">
        </div>

        <div id="insights" class="space-y-4 relative z-10 text-sm text-gray-600 dark:text-gray-300">
          <div class="flex items-start gap-3">
            <i class="ph ph-sparkle text-yellow-500 mt-1"></i>
            <p>Analysis in progress... Eat a few meals to get personalized patterns!</p>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (async function initDashboard() {
    // --- Setup & UI ---
    const hours = new Date().getHours();
    const part = hours < 12 ? 'morning' : hours < 18 ? 'afternoon' : 'evening';
    // Attempt to get name safely
    const greetingEl = document.getElementById('welcomeHeading');
    // Logic to keep part of the jinja template or just client side update
    // We'll trust the server rendered part if valid, else update client side

    // Wire Buttons
    const quickMealBtn = document.getElementById('quickMeal');
    if (quickMealBtn) quickMealBtn.addEventListener('click', () => { window.location.href = '/'; });

    const logWaterBtn = document.getElementById('logWater');
    if (logWaterBtn) logWaterBtn.addEventListener('click', async () => {
      logWaterBtn.disabled = true;
      logWaterBtn.classList.add('opacity-75');
      try {
        await fetch('/api/dashboard/hydration', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ add_glasses: 1, add_ml: 250 }) });
        // Refresh just hydration part or page? Page for simplicity
        location.reload();
      } catch (_) {
        logWaterBtn.disabled = false;
      }
    });

    // Load Data
    let data;
    try {
      const res = await fetch('/api/dashboard/today');
      data = await res.json();
      if (!data.success) throw new Error(data.error || 'User not logged in?');
    } catch (err) {
      console.warn(err);
      document.getElementById('dayProgress').textContent = 'Please sign in to view dashboard.';
      document.getElementById('mealsList').innerHTML = `
        <div class="glass-panel p-8 text-center rounded-2xl">
           <p class="text-gray-500 mb-4">Sign in to track your meals.</p>
           <a href="/" class="btn-primary px-4 py-2 rounded-lg text-sm">Go to Home</a>
        </div>
    `;
      return;
    }

    // 1. Date Progress
    const now = new Date();
    const started = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    // Determine if it's already "tomorrow" relative to start of day? No, just % of passed hours
    const minutesPassed = hours * 60 + now.getMinutes();
    const pctDay = Math.round((minutesPassed / (24 * 60)) * 100);
    document.getElementById('dayProgress').textContent = `${now.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} â€¢ ${pctDay}% of day elapsed`;

    // 2. Calories
    const consumed = data.totals.calories || 0;
    const target = data.targets.calories || 2000; // Default fallback
    const remain = Math.max(0, target - consumed);

    document.getElementById('caloriesConsumed').innerText = Math.round(consumed);
    document.getElementById('caloriesTarget').innerText = Math.round(target);
    document.getElementById('caloriesRemain').innerText = Math.round(remain);

    // Ring calc
    const pct = Math.min(100, Math.round((consumed / target) * 100));
    // Circle perimeter ~ 100 units for stroke-dasharray?
    // SVG path length: 2 * pi * 16 â‰ˆ 100.5. stroke-dasharray="current, 100" maps nicely.
    document.getElementById('calProgressPath').setAttribute('stroke-dasharray', `${pct}, 100`);

    if (pct > 100) document.getElementById('calProgressPath').classList.replace('text-green-500', 'text-red-500');

    // 3. Macros
    const t = data.targets.macros_g || {};
    const g = { protein: data.totals.protein_g || 0, carbs: data.totals.carbs_g || 0, fat: data.totals.fat_g || 0 };

    const updateMacro = (id, val, max, colorClass) => {
      document.getElementById(`${id}G`).innerText = Math.round(val);
      document.getElementById(`${id}T`).innerText = max ? Math.round(max) : '-';
      const w = max ? Math.min(100, (val / max) * 100) : 0;
      const bar = document.getElementById(`${id}Bar`);
      bar.style.width = `${w}%`;
    }

    updateMacro('pro', g.protein, t.protein);
    updateMacro('carb', g.carbs, t.carbs);
    updateMacro('fat', g.fat, t.fat);

    // 4. Score
    if (data.adherence_avg != null) {
      document.getElementById('dietScore').innerText = data.adherence_avg.toFixed(1);
    } else {
      document.getElementById('dietScore').innerText = '-';
    }
    document.getElementById('dietBadge').innerText = (data.diet_type || 'General').replace(/_/g, ' ');

    // 5. Hydration
    const glasses = data.hydration.glasses || 0;
    const hContainer = document.getElementById('hydrationDrops');
    hContainer.innerHTML = '';
    // Show 8 slots
    for (let i = 0; i < 8; i++) {
      const active = i < glasses;
      const el = document.createElement('div');
      el.className = `flex-1 h-8 rounded-lg flex items-center justify-center transition-all ${active ? 'bg-blue-500 text-white shadow-sm' : 'bg-gray-100 dark:bg-gray-800 text-gray-300'}`;
      el.innerHTML = '<i class="ph ph-drop-fill"></i>';
      hContainer.appendChild(el);
    }
    document.getElementById('hydrationMl').innerText = data.hydration.ml || 0;

    // 6. Meals List (Base64 Aware)
    const mealsEl = document.getElementById('mealsList');
    if (!data.meals || data.meals.length === 0) {
      mealsEl.innerHTML = `
        <div class="glass-panel p-8 text-center rounded-2xl border-dashed border-2 border-gray-200 dark:border-gray-700">
           <div class="w-12 h-12 bg-green-50 dark:bg-green-900/20 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600">
                <i class="ph ph-camera-plus text-xl"></i>
           </div>
           <p class="text-gray-500 mb-4">No meals logged today.</p>
           <a href="/" class="btn-primary px-5 py-2 rounded-xl text-sm">Log Your First Meal</a>
        </div>
      `;
    } else {
      mealsEl.innerHTML = data.meals.map(m => {
        const sj = m.analysis_json || {};
        const p = m.personalization || {};
        let score = (p.macro_adherence && p.macro_adherence.score != null) ? p.macro_adherence.score : null;

        const timeStr = m.ts ? new Date(m.ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
        const name = (typeof sj.meal_identification === 'object' ? sj.meal_identification?.name : sj.meal_identification) || 'Unknown Meal';
        const cal = sj.calories_kcal || (sj.total_nutrition ? sj.total_nutrition.calories : 'â€”');

        let imgHtml = '';
        // Prioritize Base64, then path
        if (m.image_base64) {
          imgHtml = `<img src="data:image/jpeg;base64,${m.image_base64}" class="w-full h-full object-cover">`;
        } else if (m.image_path) {
          // Same fallback logic as history
          let src = m.image_path;
          if (src.startsWith('static') || src.startsWith('/static')) {
            imgHtml = `<img src="${src}" class="w-full h-full object-cover">`;
          } else {
            imgHtml = `<div class="w-full h-full bg-gray-200 flex items-center justify-center text-xs text-gray-400">No Img</div>`;
          }
        }

        let scoreBadge = '';
        if (score !== null) {
          let color = score >= 8 ? 'bg-green-100 text-green-700' : score >= 5 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700';
          scoreBadge = `<span class="px-2 py-1 rounded-md text-xs font-bold ${color}">${score}/10</span>`;
        }

        return `
            <div class="glass-panel rounded-xl p-3 flex items-center gap-4 hover:shadow-md transition-all">
                <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 flex-shrink-0">
                    ${imgHtml}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1">
                        <h4 class="font-bold text-gray-900 dark:text-gray-100 truncate">${name}</h4>
                        <span class="text-xs text-gray-500">${timeStr}</span>
                    </div>
                    <div class="flex items-center gap-3 text-sm text-gray-600 dark:text-gray-400">
                        <span class="flex items-center gap-1"><i class="ph ph-fire"></i> ${cal} kcal</span>
                        ${scoreBadge}
                    </div>
                </div>
            </div>
          `;
      }).join('');
    }

    // 7. Insights
    if (data.meals && data.meals.length > 0) {
      try {
        const ir = await fetch('/api/dashboard/insights');
        const idata = await ir.json();
        if (idata.success && Array.isArray(idata.insights) && idata.insights.length > 0) {
          const container = document.getElementById('insights');
          container.innerHTML = idata.insights.map((txt, idx) => `
            <div class="flex items-start gap-3 p-3 rounded-lg bg-white/40 dark:bg-white/5 border border-white/20 dark:border-white/10">
                <span class="text-lg">${['ðŸ’¡', 'ðŸ¥¦', 'ðŸ”¥'][idx % 3]}</span>
                <p class="text-xs leading-relaxed opacity-90">${txt}</p>
            </div>
          `).join('');
        }
      } catch (_) { }
    }

  })();
</script>
{% endblock %}