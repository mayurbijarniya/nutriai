{% extends "base.html" %}

{% block title %}Integrations & Reminders - NutriAI{% endblock %}

{% block head %}
<style>
    .switch {
        position: relative;
        display: inline-flex;
        width: 2.75rem;
        height: 1.6rem;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.55);
        border: 1px solid rgba(15, 23, 42, 0.16);
        transition: all 0.2s ease;
    }

    .switch::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 0.18rem;
        width: 1.15rem;
        height: 1.15rem;
        border-radius: 999px;
        background: #ffffff;
        transform: translateY(-50%);
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.25);
    }

    .switch-input:checked + .switch {
        background: rgba(16, 185, 129, 0.35);
        border-color: rgba(16, 185, 129, 0.6);
    }

    .switch-input:checked + .switch::after {
        left: 1.35rem;
        background: #10b981;
    }

    .dark .switch {
        background: rgba(51, 65, 85, 0.9);
        border-color: rgba(148, 163, 184, 0.25);
    }

    .dark .switch::after {
        background: #e2e8f0;
    }

    .dark .switch-input:checked + .switch {
        background: rgba(16, 185, 129, 0.25);
        border-color: rgba(52, 211, 153, 0.65);
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 space-y-5 sm:space-y-7">
    <section class="glass-panel rounded-3xl p-4 sm:p-6 border border-white/30 dark:border-white/10 overflow-hidden relative">
        <div class="absolute -top-20 -right-16 w-64 h-64 bg-cyan-300/20 dark:bg-cyan-500/20 blur-3xl rounded-full pointer-events-none"></div>
        <div class="absolute -bottom-24 -left-16 w-64 h-64 bg-emerald-300/20 dark:bg-emerald-500/20 blur-3xl rounded-full pointer-events-none"></div>
        <div class="relative grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white font-serif-accent">Integrations & Reminders</h1>
                <p class="text-sm sm:text-base text-gray-600 dark:text-gray-300 mt-1">Control notification behavior and track provider rollout from one consistent settings hub.</p>
            </div>
            <div class="grid grid-cols-3 gap-2 sm:gap-3">
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="kpiConnected" class="text-lg sm:text-xl font-bold">0</p>
                    <p class="text-[11px] text-gray-500">Live</p>
                </div>
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="kpiReminders" class="text-lg sm:text-xl font-bold">0</p>
                    <p class="text-[11px] text-gray-500">Enabled</p>
                </div>
                <div class="surface-solid rounded-2xl p-3 text-center">
                    <p id="kpiTimezone" class="text-[12px] sm:text-sm font-bold truncate">UTC</p>
                    <p class="text-[11px] text-gray-500">Timezone</p>
                </div>
            </div>
        </div>
    </section>

    <div class="grid grid-cols-1 xl:grid-cols-3 gap-4 sm:gap-6">
        <aside class="xl:col-span-1 space-y-3 xl:sticky xl:top-28 self-start">
            <div class="glass-panel rounded-2xl p-4 sm:p-5 border border-white/30 dark:border-white/10">
                <h2 class="text-base sm:text-lg font-bold mb-4">Reminder Settings</h2>

                <div class="space-y-2.5">
                    <div class="surface-solid rounded-xl p-3 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold">Hydration reminders</p>
                            <p class="text-xs text-gray-500">Water intake nudges during the day.</p>
                        </div>
                        <label class="cursor-pointer">
                            <input id="rHydration" type="checkbox" class="switch-input sr-only">
                            <span class="switch"></span>
                        </label>
                    </div>

                    <div class="surface-solid rounded-xl p-3 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold">Meal logging reminders</p>
                            <p class="text-xs text-gray-500">Prompt to log meals consistently.</p>
                        </div>
                        <label class="cursor-pointer">
                            <input id="rMeals" type="checkbox" class="switch-input sr-only">
                            <span class="switch"></span>
                        </label>
                    </div>

                    <div class="surface-solid rounded-xl p-3 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold">Weekly check-in reminders</p>
                            <p class="text-xs text-gray-500">End-of-week reflection prompt.</p>
                        </div>
                        <label class="cursor-pointer">
                            <input id="rWeekly" type="checkbox" class="switch-input sr-only">
                            <span class="switch"></span>
                        </label>
                    </div>

                    <div class="surface-solid rounded-xl p-3 flex items-center justify-between">
                        <div>
                            <p class="text-sm font-semibold">Email reminders</p>
                            <p class="text-xs text-gray-500">Receive reminders via email channel.</p>
                        </div>
                        <label class="cursor-pointer">
                            <input id="rEmail" type="checkbox" class="switch-input sr-only">
                            <span class="switch"></span>
                        </label>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="block text-xs font-semibold text-gray-500 mb-1">Timezone</label>
                    <div class="control-strip">
                        <div class="relative flex-1">
                            <i class="ph ph-globe-hemisphere-east absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                            <input id="rTimezone" class="selector-pill w-full pl-9 pr-3 py-2 text-sm" placeholder="e.g. America/New_York" list="timezoneHints" />
                        </div>
                        <button id="detectTimezone" class="btn-secondary px-3 py-2 rounded-xl text-xs whitespace-nowrap">Detect</button>
                    </div>
                    <datalist id="timezoneHints">
                        <option value="UTC"></option>
                        <option value="America/New_York"></option>
                        <option value="America/Chicago"></option>
                        <option value="America/Los_Angeles"></option>
                        <option value="Europe/London"></option>
                        <option value="Asia/Kolkata"></option>
                        <option value="Asia/Dubai"></option>
                    </datalist>
                </div>

                <button id="saveReminders" class="btn-primary w-full py-2.5 rounded-xl text-sm font-semibold inline-flex items-center justify-center gap-2 mt-3">
                    <i class="ph ph-floppy-disk"></i>
                    <span>Save Reminder Settings</span>
                </button>

                <p id="reminderStatus" class="text-xs mt-2 hidden"></p>
            </div>
        </aside>

        <section class="xl:col-span-2 glass-panel rounded-2xl p-4 sm:p-5 border border-white/30 dark:border-white/10">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                <div>
                    <h2 class="text-base sm:text-lg font-bold">Fitness Integrations</h2>
                    <p class="text-xs text-gray-500 mt-0.5">Provider sync rollout is in progress. Connect activates when OAuth is live.</p>
                </div>
                <button id="refreshIntegrations" class="btn-secondary px-3 py-2 rounded-xl text-sm inline-flex items-center justify-center gap-1.5">
                    <i class="ph ph-arrows-clockwise"></i>
                    <span>Refresh</span>
                </button>
            </div>

            <div id="integrationList" class="space-y-3"></div>
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const providers = [
        { key: 'apple_health', label: 'Apple Health', icon: 'ph-apple-logo', hint: 'Daily activity and workout sync', available: false },
        { key: 'fitbit', label: 'Fitbit', icon: 'ph-watch', hint: 'Fitness band activity and sleep data', available: false },
        { key: 'google_fit', label: 'Google Fit', icon: 'ph-google-logo', hint: 'Google movement and heart metrics', available: false },
        { key: 'myfitnesspal', label: 'MyFitnessPal', icon: 'ph-fork-knife', hint: 'Calorie and macro tracking import', available: false },
    ];

    let remindersState = {
        hydration_enabled: true,
        meal_logging_enabled: true,
        weekly_checkin_enabled: true,
        email_enabled: false,
        timezone: 'UTC',
    };

    let integrationsState = [];

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function showReminderStatus(message, ok = true) {
        const el = document.getElementById('reminderStatus');
        if (!message) {
            el.textContent = '';
            el.classList.add('hidden');
            return;
        }
        el.textContent = message;
        el.className = `text-xs mt-2 ${ok ? 'text-emerald-600 dark:text-emerald-300' : 'text-red-600 dark:text-red-400'}`;
    }

    function formatDateTime(iso) {
        if (!iso) return 'Never';
        const d = new Date(iso);
        if (Number.isNaN(d.getTime())) return 'Never';
        return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function currentReminderPayload() {
        return {
            hydration_enabled: document.getElementById('rHydration').checked,
            meal_logging_enabled: document.getElementById('rMeals').checked,
            weekly_checkin_enabled: document.getElementById('rWeekly').checked,
            email_enabled: document.getElementById('rEmail').checked,
            timezone: (document.getElementById('rTimezone').value || 'UTC').trim() || 'UTC',
        };
    }

    function renderKpis() {
        const availableSet = new Set(providers.filter(p => p.available).map(p => p.key));
        const connected = integrationsState.filter(x => availableSet.has(x.provider) && x.status === 'connected').length;
        const reminderCount = [
            remindersState.hydration_enabled,
            remindersState.meal_logging_enabled,
            remindersState.weekly_checkin_enabled,
            remindersState.email_enabled,
        ].filter(Boolean).length;

        document.getElementById('kpiConnected').textContent = String(connected);
        document.getElementById('kpiReminders').textContent = String(reminderCount);
        document.getElementById('kpiTimezone').textContent = remindersState.timezone || 'UTC';
    }

    function renderIntegrations() {
        const map = {};
        integrationsState.forEach(i => { map[i.provider] = i; });

        const container = document.getElementById('integrationList');
        container.innerHTML = providers.map((p) => {
            const current = map[p.key] || { status: 'disconnected', last_sync_at: null, meta: {} };
            const connected = current.status === 'connected';
            const isLive = !!p.available;
            const statusChip = !isLive
                ? '<span class="chip-toggle text-[11px]">Coming soon</span>'
                : (connected
                    ? '<span class="chip-toggle chip-toggle-active text-[11px]">Connected</span>'
                    : '<span class="chip-toggle text-[11px]">Disconnected</span>');

            const actionButton = !isLive
                ? '<button class="btn-secondary px-4 py-2 rounded-xl text-xs font-semibold opacity-70 cursor-not-allowed" disabled>Coming soon</button>'
                : `<button class="${connected ? 'btn-secondary' : 'btn-primary'} px-4 py-2 rounded-xl text-xs font-semibold integration-action" data-provider="${escapeHtml(p.key)}" data-action="${connected ? 'disconnect' : 'connect'}">${connected ? 'Disconnect' : 'Connect'}</button>`;

            return `
                <article class="surface-solid rounded-2xl p-4 border border-white/20 dark:border-white/10">
                    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                        <div class="min-w-0 space-y-1">
                            <div class="flex flex-wrap items-center gap-2">
                                <span class="w-9 h-9 rounded-xl bg-emerald-100 dark:bg-emerald-900/35 text-emerald-700 dark:text-emerald-300 inline-flex items-center justify-center">
                                    <i class="ph ${p.icon}"></i>
                                </span>
                                <h3 class="font-semibold text-sm">${escapeHtml(p.label)}</h3>
                                ${statusChip}
                            </div>
                            <p class="text-xs text-gray-500">${escapeHtml(p.hint)}</p>
                            <div class="text-xs text-gray-500 flex flex-wrap gap-3">
                                <span>Last sync: ${isLive ? escapeHtml(formatDateTime(current.last_sync_at)) : 'Not available yet'}</span>
                                <span>${isLive ? (current.meta?.note ? escapeHtml(current.meta.note) : 'OAuth active') : 'OAuth rollout in progress.'}</span>
                            </div>
                        </div>

                        ${actionButton}
                    </div>
                </article>
            `;
        }).join('');
    }

    async function loadReminders() {
        const res = await fetch('/api/v3/settings/reminders');
        const data = await res.json();
        if (!data.success) {
            showReminderStatus(data.error || 'Could not load reminder settings.', false);
            return;
        }

        remindersState = data.settings || remindersState;
        document.getElementById('rHydration').checked = !!remindersState.hydration_enabled;
        document.getElementById('rMeals').checked = !!remindersState.meal_logging_enabled;
        document.getElementById('rWeekly').checked = !!remindersState.weekly_checkin_enabled;
        document.getElementById('rEmail').checked = !!remindersState.email_enabled;
        document.getElementById('rTimezone').value = remindersState.timezone || 'UTC';
        renderKpis();
    }

    async function saveReminders() {
        const saveBtn = document.getElementById('saveReminders');
        const payload = currentReminderPayload();
        saveBtn.disabled = true;
        saveBtn.classList.add('opacity-70', 'cursor-not-allowed');

        try {
            const res = await fetch('/api/v3/settings/reminders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (!data.success) {
                showReminderStatus(data.error || 'Save failed.', false);
                return;
            }

            remindersState = payload;
            showReminderStatus('Reminder settings saved.', true);
            renderKpis();
        } catch (_) {
            showReminderStatus('Network error while saving reminders.', false);
        } finally {
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        }
    }

    async function loadIntegrations() {
        const res = await fetch('/api/v3/settings/integrations');
        const data = await res.json();
        if (!data.success) return;
        integrationsState = data.integrations || [];
        renderIntegrations();
        renderKpis();
    }

    async function toggleIntegration(provider, action, buttonEl) {
        if (buttonEl) {
            buttonEl.disabled = true;
            buttonEl.classList.add('opacity-70', 'cursor-not-allowed');
        }
        try {
            const res = await fetch('/api/v3/settings/integrations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ provider, action }),
            });
            const data = await res.json();
            if (!data.success) return;
            await loadIntegrations();
        } finally {
            if (buttonEl) {
                buttonEl.disabled = false;
                buttonEl.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }
    }

    function detectTimezone() {
        const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        document.getElementById('rTimezone').value = tz;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('saveReminders').addEventListener('click', saveReminders);
        document.getElementById('refreshIntegrations').addEventListener('click', loadIntegrations);
        document.getElementById('detectTimezone').addEventListener('click', detectTimezone);

        document.getElementById('integrationList').addEventListener('click', async (event) => {
            const btn = event.target.closest('.integration-action');
            if (!btn) return;
            const provider = btn.dataset.provider;
            const action = btn.dataset.action;
            if (!provider || !action) return;
            await toggleIntegration(provider, action, btn);
        });

        loadReminders();
        loadIntegrations();

        if (!document.getElementById('rTimezone').value) {
            detectTimezone();
        }
    });
</script>
{% endblock %}
